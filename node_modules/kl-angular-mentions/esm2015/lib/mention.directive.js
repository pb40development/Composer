import * as tslib_1 from "tslib";
import { ComponentFactoryResolver, Directive, ElementRef, TemplateRef, ViewContainerRef } from "@angular/core";
import { EventEmitter, Input, Output } from "@angular/core";
import { getCaretPosition, getValue, insertValue, setCaretPosition } from './mention-utils';
import { MentionListComponent } from './mention-list.component';
const KEY_BACKSPACE = 8;
const KEY_TAB = 9;
const KEY_ENTER = 13;
const KEY_SHIFT = 16;
const KEY_ESCAPE = 27;
const KEY_SPACE = 32;
const KEY_LEFT = 37;
const KEY_UP = 38;
const KEY_RIGHT = 39;
const KEY_DOWN = 40;
const KEY_BUFFERED = 229;
/**
* Angular Mentions.
* https://github.com/dmacfarlane/angular-mentions
*
* Copyright (c) 2017 Dan MacFarlane
*/
let MentionDirective = class MentionDirective {
    constructor(_element, _componentResolver, _viewContainerRef) {
        this._element = _element;
        this._componentResolver = _componentResolver;
        this._viewContainerRef = _viewContainerRef;
        // the provided configuration object
        this.mentionConfig = { items: [] };
        this.DEFAULT_CONFIG = {
            items: [],
            triggerChar: '@',
            labelKey: 'label',
            maxItems: -1,
            allowSpace: false,
            returnTrigger: true,
            insertHTML: true,
            mentionSelect: (item, triggerChar) => this.activeConfig.triggerChar + item[this.activeConfig.labelKey]
        };
        // event emitted whenever the search term changes
        this.searchTerm = new EventEmitter();
        // event emitted when an item is selected
        this.itemSelected = new EventEmitter();
        // event emitted whenever the mention list is opened or closed
        this.opened = new EventEmitter();
        this.closed = new EventEmitter();
        this.triggerChars = {};
    }
    set mention(items) {
        this.mentionItems = items;
    }
    ngOnChanges(changes) {
        // console.log('config change', changes);
        if (changes['mention'] || changes['mentionConfig']) {
            this.updateConfig();
        }
    }
    updateConfig() {
        let config = this.mentionConfig;
        this.triggerChars = {};
        // use items from directive if they have been set
        if (this.mentionItems) {
            config.items = this.mentionItems;
        }
        this.addConfig(config);
        // nested configs
        if (config.mentions) {
            config.mentions.forEach(config => this.addConfig(config));
        }
    }
    // add configuration for a trigger char
    addConfig(config) {
        // defaults
        let defaults = Object.assign({}, this.DEFAULT_CONFIG);
        config = Object.assign(defaults, config);
        // items
        let items = config.items;
        if (items && items.length > 0) {
            // convert strings to objects
            if (typeof items[0] == 'string') {
                items = items.map((label) => {
                    let object = {};
                    object[config.labelKey] = label;
                    return object;
                });
            }
            if (config.labelKey) {
                // remove items without an labelKey (as it's required to filter the list)
                items = items.filter(e => e[config.labelKey]);
                if (!config.disableSort) {
                    items.sort((a, b) => a[config.labelKey].localeCompare(b[config.labelKey]));
                }
            }
        }
        config.items = items;
        // add the config
        this.triggerChars[config.triggerChar] = config;
        // for async update while menu/search is active
        if (this.activeConfig && this.activeConfig.triggerChar == config.triggerChar) {
            this.activeConfig = config;
            this.updateSearchList();
        }
    }
    setIframe(iframe) {
        this.iframe = iframe;
    }
    stopEvent(event) {
        //if (event instanceof KeyboardEvent) { // does not work for iframe
        if (!event.wasClick) {
            event.preventDefault();
            event.stopPropagation();
            event.stopImmediatePropagation();
            //return false;
        }
    }
    blurHandler(event) {
        this.stopEvent(event);
        this.stopSearch();
    }
    inputHandler(event, nativeElement = this._element.nativeElement) {
        if (this.lastKeyCode === KEY_BUFFERED && event.data) {
            let keyCode = event.data.charCodeAt(0);
            this.keyHandler({ keyCode, inputEvent: true }, nativeElement);
        }
    }
    // @param nativeElement is the alternative text element in an iframe scenario
    keyHandler(event, nativeElement = this._element.nativeElement) {
        this.lastKeyCode = event.keyCode;
        if (event.isComposing || event.keyCode === KEY_BUFFERED) {
            return;
        }
        let val = getValue(nativeElement);
        //console.log(val);
        let pos = getCaretPosition(nativeElement, this.iframe);
        //pos = pos - 170;
        //console.log('pos inicial:' + pos);
        let charPressed = event.key;
        if (!charPressed) {
            let charCode = event.which || event.keyCode;
            if (!event.shiftKey && (charCode >= 65 && charCode <= 90)) {
                charPressed = String.fromCharCode(charCode + 32);
            }
            // else if (event.shiftKey && charCode === KEY_2) {
            //   charPressed = this.config.triggerChar;
            // }
            else {
                // TODO (dmacfarlane) fix this for non-alpha keys
                // http://stackoverflow.com/questions/2220196/how-to-decode-character-pressed-from-jquerys-keydowns-event-handler?lq=1
                charPressed = String.fromCharCode(event.which || event.keyCode);
            }
        }
        if (event.keyCode == KEY_ENTER && event.wasClick && pos < this.startPos) {
            // put caret back in position prior to contenteditable menu click
            pos = this.startNode.length;
            setCaretPosition(this.startNode, pos, this.iframe);
        }
        //console.log("keyHandler", this.startPos, pos, val, charPressed, event);
        let config = this.triggerChars[charPressed];
        if (config) {
            this.activeConfig = config;
            this.startPos = event.inputEvent ? pos - 1 : pos;
            this.startNode = (this.iframe ? this.iframe.contentWindow.getSelection() : window.getSelection()).anchorNode;
            this.searching = true;
            this.searchString = null;
            this.showSearchList(nativeElement);
            this.updateSearchList();
            if (config.returnTrigger) {
                this.searchTerm.emit(config.triggerChar);
            }
        }
        else if (this.startPos >= 0 && this.searching) {
            if (pos <= this.startPos) {
                this.searchList.hidden = true;
            }
            // ignore shift when pressed alone, but not when used with another key
            else if (event.keyCode !== KEY_SHIFT &&
                !event.metaKey &&
                !event.altKey &&
                !event.ctrlKey &&
                pos > this.startPos) {
                if (!this.activeConfig.allowSpace && event.keyCode === KEY_SPACE) {
                    this.startPos = -1;
                }
                else if (event.keyCode === KEY_BACKSPACE && pos > 0) {
                    pos--;
                    if (pos == this.startPos) {
                        this.stopSearch();
                    }
                }
                else if (!this.searchList.hidden) {
                    if (event.keyCode === KEY_TAB || event.keyCode === KEY_ENTER) {
                        //issues with primeNG editor, when pressed ENTER
                        //this.stopEvent(event);
                        if (event.keyCode === KEY_ENTER && !event.wasClick) {
                            if (pos - 170 > 0) {
                                pos = pos - 170;
                                this.startPos = this.startPos - 170;
                            }
                        }
                        //console.log('evento stopped ' + event.keyCode);
                        // emit the selected list item
                        this.itemSelected.emit(this.searchList.activeItem);
                        // optional function to format the selected item before inserting the text
                        const text = this.activeConfig.mentionSelect(this.searchList.activeItem, this.activeConfig.triggerChar);
                        //console.log(text);
                        //console.log(nativeElement);
                        //console.log(this.startPos);
                        //console.log(pos);
                        // value is inserted without a trailing space for consistency
                        // between element types (div and iframe do not preserve the space)
                        insertValue(nativeElement, this.startPos, pos, this.activeConfig.insertHTML, text, this.iframe);
                        // fire input event so angular bindings are updated
                        if ("createEvent" in document) {
                            let evt = document.createEvent("HTMLEvents");
                            if (this.iframe) {
                                // a 'change' event is required to trigger tinymce updates
                                evt.initEvent("change", true, false);
                            }
                            else {
                                evt.initEvent("input", true, false);
                            }
                            // this seems backwards, but fire the event from this elements nativeElement (not the
                            // one provided that may be in an iframe, as it won't be propogate)
                            this._element.nativeElement.dispatchEvent(evt);
                        }
                        this.startPos = -1;
                        this.stopSearch();
                        return false;
                    }
                    else if (event.keyCode === KEY_ESCAPE) {
                        this.stopEvent(event);
                        this.stopSearch();
                        return false;
                    }
                    else if (event.keyCode === KEY_DOWN) {
                        this.stopEvent(event);
                        this.searchList.activateNextItem();
                        return false;
                    }
                    else if (event.keyCode === KEY_UP) {
                        this.stopEvent(event);
                        this.searchList.activatePreviousItem();
                        return false;
                    }
                }
                if (charPressed.length != 1 && event.keyCode != KEY_BACKSPACE) {
                    this.stopEvent(event);
                    return false;
                }
                else if (this.searching) {
                    let mention = val.substring(this.startPos + 1, pos);
                    if (event.keyCode !== KEY_BACKSPACE && !event.inputEvent) {
                        mention += charPressed;
                    }
                    this.searchString = mention;
                    if (this.activeConfig.returnTrigger) {
                        const triggerChar = (this.searchString || event.keyCode === KEY_BACKSPACE) ? val.substring(this.startPos, this.startPos + 1) : '';
                        this.searchTerm.emit(triggerChar + this.searchString);
                    }
                    else {
                        this.searchTerm.emit(this.searchString);
                    }
                    this.updateSearchList();
                }
            }
        }
    }
    // exposed for external calls to open the mention list, e.g. by clicking a button
    startSearch(triggerChar, nativeElement = this._element.nativeElement) {
        triggerChar = triggerChar || this.mentionConfig.triggerChar || this.DEFAULT_CONFIG.triggerChar;
        const pos = getCaretPosition(nativeElement, this.iframe);
        insertValue(nativeElement, pos, pos, this.activeConfig.insertHTML, triggerChar, this.iframe);
        this.keyHandler({ key: triggerChar, inputEvent: true }, nativeElement);
    }
    stopSearch() {
        if (this.searchList && !this.searchList.hidden) {
            this.searchList.hidden = true;
            this.closed.emit();
        }
        this.activeConfig = null;
        this.searching = false;
    }
    updateSearchList() {
        let matches = [];
        if (this.activeConfig && this.activeConfig.items) {
            let objects = this.activeConfig.items;
            // disabling the search relies on the async operation to do the filtering
            if (!this.activeConfig.disableSearch && this.searchString && this.activeConfig.labelKey) {
                let searchStringLowerCase = this.searchString.toLowerCase();
                objects = objects.filter(e => e[this.activeConfig.labelKey].toLowerCase().startsWith(searchStringLowerCase));
            }
            matches = objects;
            if (this.activeConfig.maxItems > 0) {
                matches = matches.slice(0, this.activeConfig.maxItems);
            }
        }
        // update the search list
        if (this.searchList) {
            this.searchList.items = matches;
            this.searchList.hidden = matches.length == 0;
        }
    }
    showSearchList(nativeElement) {
        this.opened.emit();
        if (this.searchList == null) {
            let componentFactory = this._componentResolver.resolveComponentFactory(MentionListComponent);
            let componentRef = this._viewContainerRef.createComponent(componentFactory);
            this.searchList = componentRef.instance;
            this.searchList.itemTemplate = this.mentionListTemplate;
            componentRef.instance['itemClick'].subscribe(() => {
                nativeElement.focus();
                let fakeKeydown = { key: 'Enter', keyCode: KEY_ENTER, wasClick: true };
                this.keyHandler(fakeKeydown, nativeElement);
            });
        }
        this.searchList.labelKey = this.activeConfig.labelKey;
        this.searchList.dropUp = this.activeConfig.dropUp;
        this.searchList.styleOff = this.mentionConfig.disableStyle;
        this.searchList.activeIndex = 0;
        this.searchList.position(nativeElement, this.iframe);
        window.requestAnimationFrame(() => this.searchList.reset());
    }
};
MentionDirective.ctorParameters = () => [
    { type: ElementRef },
    { type: ComponentFactoryResolver },
    { type: ViewContainerRef }
];
tslib_1.__decorate([
    Input('mention'),
    tslib_1.__metadata("design:type", Array),
    tslib_1.__metadata("design:paramtypes", [Array])
], MentionDirective.prototype, "mention", null);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Object)
], MentionDirective.prototype, "mentionConfig", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", TemplateRef)
], MentionDirective.prototype, "mentionListTemplate", void 0);
tslib_1.__decorate([
    Output(),
    tslib_1.__metadata("design:type", Object)
], MentionDirective.prototype, "searchTerm", void 0);
tslib_1.__decorate([
    Output(),
    tslib_1.__metadata("design:type", Object)
], MentionDirective.prototype, "itemSelected", void 0);
tslib_1.__decorate([
    Output(),
    tslib_1.__metadata("design:type", Object)
], MentionDirective.prototype, "opened", void 0);
tslib_1.__decorate([
    Output(),
    tslib_1.__metadata("design:type", Object)
], MentionDirective.prototype, "closed", void 0);
MentionDirective = tslib_1.__decorate([
    Directive({
        selector: '[mention], [mentionConfig]',
        host: {
            '(keydown)': 'keyHandler($event)',
            '(input)': 'inputHandler($event)',
            '(blur)': 'blurHandler($event)',
            'autocomplete': 'off'
        }
    }),
    tslib_1.__metadata("design:paramtypes", [ElementRef,
        ComponentFactoryResolver,
        ViewContainerRef])
], MentionDirective);
export { MentionDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVudGlvbi5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9rbC1hbmd1bGFyLW1lbnRpb25zLyIsInNvdXJjZXMiOlsibGliL21lbnRpb24uZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDL0csT0FBTyxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQWEsTUFBTSxFQUFpQixNQUFNLGVBQWUsQ0FBQztBQUN0RixPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsUUFBUSxFQUFFLFdBQVcsRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRzVGLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBRWhFLE1BQU0sYUFBYSxHQUFHLENBQUMsQ0FBQztBQUN4QixNQUFNLE9BQU8sR0FBRyxDQUFDLENBQUM7QUFDbEIsTUFBTSxTQUFTLEdBQUcsRUFBRSxDQUFDO0FBQ3JCLE1BQU0sU0FBUyxHQUFHLEVBQUUsQ0FBQztBQUNyQixNQUFNLFVBQVUsR0FBRyxFQUFFLENBQUM7QUFDdEIsTUFBTSxTQUFTLEdBQUcsRUFBRSxDQUFDO0FBQ3JCLE1BQU0sUUFBUSxHQUFHLEVBQUUsQ0FBQztBQUNwQixNQUFNLE1BQU0sR0FBRyxFQUFFLENBQUM7QUFDbEIsTUFBTSxTQUFTLEdBQUcsRUFBRSxDQUFDO0FBQ3JCLE1BQU0sUUFBUSxHQUFHLEVBQUUsQ0FBQztBQUNwQixNQUFNLFlBQVksR0FBRyxHQUFHLENBQUM7QUFFekI7Ozs7O0VBS0U7QUFVRixJQUFhLGdCQUFnQixHQUE3QixNQUFhLGdCQUFnQjtJQWdEM0IsWUFDVSxRQUFvQixFQUNwQixrQkFBNEMsRUFDNUMsaUJBQW1DO1FBRm5DLGFBQVEsR0FBUixRQUFRLENBQVk7UUFDcEIsdUJBQWtCLEdBQWxCLGtCQUFr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QUFFLHFCQUFxQjtZQUMvQixjQUFjLEVBQUUsS0FBSztTQUN0QjtLQUNGLENBQUM7NkNBa0RvQixVQUFVO1FBQ0Esd0JBQXdCO1FBQ3pCLGdCQUFnQjtHQW5EbEMsZ0JBQWdCLENBaVd4QjtTQWpXUSxnQkFBZ0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsIERpcmVjdGl2ZSwgRWxlbWVudFJlZiwgVGVtcGxhdGVSZWYsIFZpZXdDb250YWluZXJSZWYgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xyXG5pbXBvcnQgeyBFdmVudEVtaXR0ZXIsIElucHV0LCBPbkNoYW5nZXMsIE91dHB1dCwgU2ltcGxlQ2hhbmdlcyB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XHJcbmltcG9ydCB7IGdldENhcmV0UG9zaXRpb24sIGdldFZhbHVlLCBpbnNlcnRWYWx1ZSwgc2V0Q2FyZXRQb3NpdGlvbiB9IGZyb20gJy4vbWVudGlvbi11dGlscyc7XHJcblxyXG5pbXBvcnQgeyBNZW50aW9uQ29uZmlnIH0gZnJvbSBcIi4vbWVudGlvbi1jb25maWdcIjtcclxuaW1wb3J0IHsgTWVudGlvbkxpc3RDb21wb25lbnQgfSBmcm9tICcuL21lbnRpb24tbGlzdC5jb21wb25lbnQnO1xyXG5cclxuY29uc3QgS0VZX0JBQ0tTUEFDRSA9IDg7XHJcbmNvbnN0IEtFWV9UQUIgPSA5O1xyXG5jb25zdCBLRVlfRU5URVIgPSAxMztcclxuY29uc3QgS0VZX1NISUZUID0gMTY7XHJcbmNvbnN0IEtFWV9FU0NBUEUgPSAyNztcclxuY29uc3QgS0VZX1NQQUNFID0gMzI7XHJcbmNvbnN0IEtFWV9MRUZUID0gMzc7XHJcbmNvbnN0IEtFWV9VUCA9IDM4O1xyXG5jb25zdCBLRVlfUklHSFQgPSAzOTtcclxuY29uc3QgS0VZX0RPV04gPSA0MDtcclxuY29uc3QgS0VZX0JVRkZFUkVEID0gMjI5O1xyXG5cclxuLyoqXHJcbiogQW5ndWxhciBNZW50aW9ucy5cclxuKiBodHRwczovL2dpdGh1Yi5jb20vZG1hY2ZhcmxhbmUvYW5ndWxhci1tZW50aW9uc1xyXG4qXHJcbiogQ29weXJpZ2h0IChjKSAyMDE3IERhbiBNYWNGYXJsYW5lXHJcbiovXHJcbkBEaXJlY3RpdmUoe1xyXG4gIHNlbGVjdG9yOiAnW21lbnRpb25dLCBbbWVudGlvbkNvbmZpZ10nLFxyXG4gIGhvc3Q6IHtcclxuICAgICcoa2V5ZG93biknOiAna2V5SGFuZGxlcigkZXZlbnQpJyxcclxuICAgICcoaW5wdXQpJzogJ2lucHV0SGFuZGxlcigkZXZlbnQpJyxcclxuICAgICcoYmx1ciknOiAnYmx1ckhhbmRsZXIoJGV2ZW50KScsXHJcbiAgICAnYXV0b2NvbXBsZXRlJzogJ29mZidcclxuICB9XHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBNZW50aW9uRGlyZWN0aXZlIGltcGxlbWVudHMgT25DaGFuZ2VzIHtcclxuICBcclxuICAvLyBzdG9yZXMgdGhlIGl0ZW1zIHBhc3NlZCB0byB0aGUgbWVudGlvbnMgZGlyZWN0aXZlIGFuZCB1c2VkIHRvIHBvcHVsYXRlIHRoZSByb290IGl0ZW1zIGluIG1lbnRpb25Db25maWdcclxuICBwcml2YXRlIG1lbnRpb25JdGVtczogYW55W107XHJcbiAgXHJcbiAgQElucHV0KCdtZW50aW9uJykgc2V0IG1lbnRpb24oaXRlbXM6IGFueVtdKSB7XHJcbiAgICB0aGlzLm1lbnRpb25JdGVtcyA9IGl0ZW1zO1xyXG4gIH1cclxuICBcclxuICAvLyB0aGUgcHJvdmlkZWQgY29uZmlndXJhdGlvbiBvYmplY3RcclxuICBASW5wdXQoKSBtZW50aW9uQ29uZmlnOiBNZW50aW9uQ29uZmlnID0geyBpdGVtczogW10gfTtcclxuICBcclxuICBwcml2YXRlIGFjdGl2ZUNvbmZpZzogTWVudGlvbkNvbmZpZztcclxuICBcclxuICBwcml2YXRlIERFRkFVTFRfQ09ORklHOiBNZW50aW9uQ29uZmlnID0ge1xyXG4gICAgaXRlbXM6IFtdLFxyXG4gICAgdHJpZ2dlckNoYXI6ICdAJyxcclxuICAgIGxhYmVsS2V5OiAnbGFiZWwnLFxyXG4gICAgbWF4SXRlbXM6IC0xLFxyXG4gICAgYWxsb3dTcGFjZTogZmFsc2UsXHJcbiAgICByZXR1cm5UcmlnZ2VyOiB0cnVlLFxyXG4gICAgaW5zZXJ0SFRNTDogdHJ1ZSxcclxuICAgIG1lbnRpb25TZWxlY3Q6IChpdGVtOiBhbnksIHRyaWdnZXJDaGFyPzpzdHJpbmcpID0+IHRoaXMuYWN0aXZlQ29uZmlnLnRyaWdnZXJDaGFyICsgaXRlbVt0aGlzLmFjdGl2ZUNvbmZpZy5sYWJlbEtleV1cclxuICB9XHJcbiAgXHJcbiAgLy8gdGVtcGxhdGUgdG8gdXNlIGZvciByZW5kZXJpbmcgbGlzdCBpdGVtc1xyXG4gIEBJbnB1dCgpIG1lbnRpb25MaXN0VGVtcGxhdGU6IFRlbXBsYXRlUmVmPGFueT47XHJcbiAgXHJcbiAgLy8gZXZlbnQgZW1pdHRlZCB3aGVuZXZlciB0aGUgc2VhcmNoIHRlcm0gY2hhbmdlc1xyXG4gIEBPdXRwdXQoKSBzZWFyY2hUZXJtID0gbmV3IEV2ZW50RW1pdHRlcjxzdHJpbmc+KCk7XHJcbiAgXHJcbiAgLy8gZXZlbnQgZW1pdHRlZCB3aGVuIGFuIGl0ZW0gaXMgc2VsZWN0ZWRcclxuICBAT3V0cHV0KCkgaXRlbVNlbGVjdGVkID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XHJcbiAgXHJcbiAgLy8gZXZlbnQgZW1pdHRlZCB3aGVuZXZlciB0aGUgbWVudGlvbiBsaXN0IGlzIG9wZW5lZCBvciBjbG9zZWRcclxuICBAT3V0cHV0KCkgb3BlbmVkID0gbmV3IEV2ZW50RW1pdHRlcigpO1xyXG4gIEBPdXRwdXQoKSBjbG9zZWQgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XHJcbiAgXHJcbiAgcHJpdmF0ZSB0cmlnZ2VyQ2hhcnM6IHsgW2tleTogc3RyaW5nXTogTWVudGlvbkNvbmZpZyB9ID0ge307XHJcbiAgXHJcbiAgcHJpdmF0ZSBzZWFyY2hTdHJpbmc6IHN0cmluZztcclxuICBwcml2YXRlIHN0YXJ0UG9zOiBudW1iZXI7XHJcbiAgcHJpdmF0ZSBzdGFydE5vZGU7XHJcbiAgcHJpdmF0ZSBzZWFyY2hMaXN0OiBNZW50aW9uTGlzdENvbXBvbmVudDtcclxuICBwcml2YXRlIHNlYXJjaGluZzogYm9vbGVhbjtcclxuICBwcml2YXRlIGlmcmFtZTogYW55OyAvLyBvcHRpb25hbFxyXG4gIHByaXZhdGUgbGFzdEtleUNvZGU6IG51bWJlcjtcclxuICBcclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgX2VsZW1lbnQ6IEVsZW1lbnRSZWYsXHJcbiAgICBwcml2YXRlIF9jb21wb25lbnRSZXNvbHZlcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxyXG4gICAgcHJpdmF0ZSBfdmlld0NvbnRhaW5lclJlZjogVmlld0NvbnRhaW5lclJlZlxyXG4gICAgKSB7IH1cclxuICAgIFxyXG4gICAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xyXG4gICAgICAvLyBjb25zb2xlLmxvZygnY29uZmlnIGNoYW5nZScsIGNoYW5nZXMpO1xyXG4gICAgICBpZiAoY2hhbmdlc1snbWVudGlvbiddIHx8IGNoYW5nZXNbJ21lbnRpb25Db25maWcnXSkge1xyXG4gICAgICAgIHRoaXMudXBkYXRlQ29uZmlnKCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIFxyXG4gICAgcHVibGljIHVwZGF0ZUNvbmZpZygpIHtcclxuICAgICAgbGV0IGNvbmZpZyA9IHRoaXMubWVudGlvbkNvbmZpZztcclxuICAgICAgdGhpcy50cmlnZ2VyQ2hhcnMgPSB7fTtcclxuICAgICAgLy8gdXNlIGl0ZW1zIGZyb20gZGlyZWN0aXZlIGlmIHRoZXkgaGF2ZSBiZWVuIHNldFxyXG4gICAgICBpZiAodGhpcy5tZW50aW9uSXRlbXMpIHtcclxuICAgICAgICBjb25maWcuaXRlbXMgPSB0aGlzLm1lbnRpb25JdGVtcztcclxuICAgICAgfVxyXG4gICAgICB0aGlzLmFkZENvbmZpZyhjb25maWcpO1xyXG4gICAgICAvLyBuZXN0ZWQgY29uZmlnc1xyXG4gICAgICBpZiAoY29uZmlnLm1lbnRpb25zKSB7XHJcbiAgICAgICAgY29uZmlnLm1lbnRpb25zLmZvckVhY2goY29uZmlnID0+IHRoaXMuYWRkQ29uZmlnKGNvbmZpZykpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBcclxuICAgIC8vIGFkZCBjb25maWd1cmF0aW9uIGZvciBhIHRyaWdnZXIgY2hhclxyXG4gICAgcHJpdmF0ZSBhZGRDb25maWcoY29uZmlnOiBNZW50aW9uQ29uZmlnKSB7XHJcbiAgICAgIC8vIGRlZmF1bHRzXHJcbiAgICAgIGxldCBkZWZhdWx0cyA9IE9iamVjdC5hc3NpZ24oe30sIHRoaXMuREVGQVVMVF9DT05GSUcpO1xyXG4gICAgICBjb25maWcgPSBPYmplY3QuYXNzaWduKGRlZmF1bHRzLCBjb25maWcpO1xyXG4gICAgICAvLyBpdGVtc1xyXG4gICAgICBsZXQgaXRlbXMgPSBjb25maWcuaXRlbXM7XHJcbiAgICAgIGlmIChpdGVtcyAmJiBpdGVtcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgLy8gY29udmVydCBzdHJpbmdzIHRvIG9iamVjdHNcclxuICAgICAgICBpZiAodHlwZW9mIGl0ZW1zWzBdID09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgICBpdGVtcyA9IGl0ZW1zLm1hcCgobGFiZWwpID0+IHtcclxuICAgICAgICAgICAgbGV0IG9iamVjdCA9IHt9O1xyXG4gICAgICAgICAgICBvYmplY3RbY29uZmlnLmxhYmVsS2V5XSA9IGxhYmVsO1xyXG4gICAgICAgICAgICByZXR1cm4gb2JqZWN0O1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChjb25maWcubGFiZWxLZXkpIHtcclxuICAgICAgICAgIC8vIHJlbW92ZSBpdGVtcyB3aXRob3V0IGFuIGxhYmVsS2V5IChhcyBpdCdzIHJlcXVpcmVkIHRvIGZpbHRlciB0aGUgbGlzdClcclxuICAgICAgICAgIGl0ZW1zID0gaXRlbXMuZmlsdGVyKGUgPT4gZVtjb25maWcubGFiZWxLZXldKTtcclxuICAgICAgICAgIGlmICghY29uZmlnLmRpc2FibGVTb3J0KSB7XHJcbiAgICAgICAgICAgIGl0ZW1zLnNvcnQoKGEsIGIpID0+IGFbY29uZmlnLmxhYmVsS2V5XS5sb2NhbGVDb21wYXJlKGJbY29uZmlnLmxhYmVsS2V5XSkpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICBjb25maWcuaXRlbXMgPSBpdGVtcztcclxuICAgICAgXHJcbiAgICAgIC8vIGFkZCB0aGUgY29uZmlnXHJcbiAgICAgIHRoaXMudHJpZ2dlckNoYXJzW2NvbmZpZy50cmlnZ2VyQ2hhcl0gPSBjb25maWc7XHJcbiAgICAgIFxyXG4gICAgICAvLyBmb3IgYXN5bmMgdXBkYXRlIHdoaWxlIG1lbnUvc2VhcmNoIGlzIGFjdGl2ZVxyXG4gICAgICBpZiAodGhpcy5hY3RpdmVDb25maWcgJiYgdGhpcy5hY3RpdmVDb25maWcudHJpZ2dlckNoYXIgPT0gY29uZmlnLnRyaWdnZXJDaGFyKSB7XHJcbiAgICAgICAgdGhpcy5hY3RpdmVDb25maWcgPSBjb25maWc7XHJcbiAgICAgICAgdGhpcy51cGRhdGVTZWFyY2hMaXN0KCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIFxyXG4gICAgc2V0SWZyYW1lKGlmcmFtZTogSFRNTElGcmFtZUVsZW1lbnQpIHtcclxuICAgICAgdGhpcy5pZnJhbWUgPSBpZnJhbWU7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIHN0b3BFdmVudChldmVudDogYW55KSB7XHJcbiAgICAgIC8vaWYgKGV2ZW50IGluc3RhbmNlb2YgS2V5Ym9hcmRFdmVudCkgeyAvLyBkb2VzIG5vdCB3b3JrIGZvciBpZnJhbWVcclxuICAgICAgXHJcbiAgICAgIGlmICghZXZlbnQud2FzQ2xpY2spIHtcclxuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICAgIGV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpO1xyXG4gICAgICAgIC8vcmV0dXJuIGZhbHNlO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGJsdXJIYW5kbGVyKGV2ZW50OiBhbnkpIHtcclxuICAgICAgdGhpcy5zdG9wRXZlbnQoZXZlbnQpO1xyXG4gICAgICB0aGlzLnN0b3BTZWFyY2goKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgaW5wdXRIYW5kbGVyKGV2ZW50OiBhbnksIG5hdGl2ZUVsZW1lbnQ6IEhUTUxJbnB1dEVsZW1lbnQgPSB0aGlzLl9lbGVtZW50Lm5hdGl2ZUVsZW1lbnQpIHtcclxuICAgICAgaWYgKHRoaXMubGFzdEtleUNvZGUgPT09IEtFWV9CVUZGRVJFRCAmJiBldmVudC5kYXRhKSB7XHJcbiAgICAgICAgbGV0IGtleUNvZGUgPSBldmVudC5kYXRhLmNoYXJDb2RlQXQoMCk7XHJcbiAgICAgICAgdGhpcy5rZXlIYW5kbGVyKHsga2V5Q29kZSwgaW5wdXRFdmVudDogdHJ1ZSB9LCBuYXRpdmVFbGVtZW50KTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgXHJcbiAgICAvLyBAcGFyYW0gbmF0aXZlRWxlbWVudCBpcyB0aGUgYWx0ZXJuYXRpdmUgdGV4dCBlbGVtZW50IGluIGFuIGlmcmFtZSBzY2VuYXJpb1xyXG4gICAga2V5SGFuZGxlcihldmVudDogYW55LCBuYXRpdmVFbGVtZW50OiBIVE1MSW5wdXRFbGVtZW50ID0gdGhpcy5fZWxlbWVudC5uYXRpdmVFbGVtZW50KSB7XHJcbiAgICAgIHRoaXMubGFzdEtleUNvZGUgPSBldmVudC5rZXlDb2RlO1xyXG4gICAgICBcclxuICAgICAgaWYgKGV2ZW50LmlzQ29tcG9zaW5nIHx8IGV2ZW50LmtleUNvZGUgPT09IEtFWV9CVUZGRVJFRCkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgICBcclxuICAgICAgbGV0IHZhbDogc3RyaW5nID0gZ2V0VmFsdWUobmF0aXZlRWxlbWVudCk7XHJcbiAgICAgIC8vY29uc29sZS5sb2codmFsKTtcclxuICAgICAgbGV0IHBvcyA9IGdldENhcmV0UG9zaXRpb24obmF0aXZlRWxlbWVudCwgdGhpcy5pZnJhbWUpO1xyXG4gICAgICAvL3BvcyA9IHBvcyAtIDE3MDtcclxuICAgICAgLy9jb25zb2xlLmxvZygncG9zIGluaWNpYWw6JyArIHBvcyk7XHJcbiAgICAgIFxyXG4gICAgICBsZXQgY2hhclByZXNzZWQgPSBldmVudC5rZXk7XHJcbiAgICAgIGlmICghY2hhclByZXNzZWQpIHtcclxuICAgICAgICBsZXQgY2hhckNvZGUgPSBldmVudC53aGljaCB8fCBldmVudC5rZXlDb2RlO1xyXG4gICAgICAgIGlmICghZXZlbnQuc2hpZnRLZXkgJiYgKGNoYXJDb2RlID49IDY1ICYmIGNoYXJDb2RlIDw9IDkwKSkge1xyXG4gICAgICAgICAgY2hhclByZXNzZWQgPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGNoYXJDb2RlICsgMzIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBlbHNlIGlmIChldmVudC5zaGlmdEtleSAmJiBjaGFyQ29kZSA9PT0gS0VZXzIpIHtcclxuICAgICAgICAvLyAgIGNoYXJQcmVzc2VkID0gdGhpcy5jb25maWcudHJpZ2dlckNoYXI7XHJcbiAgICAgICAgLy8gfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgLy8gVE9ETyAoZG1hY2ZhcmxhbmUpIGZpeCB0aGlzIGZvciBub24tYWxwaGEga2V5c1xyXG4gICAgICAgICAgLy8gaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8yMjIwMTk2L2hvdy10by1kZWNvZGUtY2hhcmFjdGVyLXByZXNzZWQtZnJvbS1qcXVlcnlzLWtleWRvd25zLWV2ZW50LWhhbmRsZXI/bHE9MVxyXG4gICAgICAgICAgY2hhclByZXNzZWQgPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGV2ZW50LndoaWNoIHx8IGV2ZW50LmtleUNvZGUpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICBpZiAoZXZlbnQua2V5Q29kZSA9PSBLRVlfRU5URVIgJiYgZXZlbnQud2FzQ2xpY2sgJiYgcG9zIDwgdGhpcy5zdGFydFBvcykge1xyXG4gICAgICAgIC8vIHB1dCBjYXJldCBiYWNrIGluIHBvc2l0aW9uIHByaW9yIHRvIGNvbnRlbnRlZGl0YWJsZSBtZW51IGNsaWNrXHJcbiAgICAgICAgcG9zID0gdGhpcy5zdGFydE5vZGUubGVuZ3RoO1xyXG4gICAgICAgIHNldENhcmV0UG9zaXRpb24odGhpcy5zdGFydE5vZGUsIHBvcywgdGhpcy5pZnJhbWUpO1xyXG4gICAgICB9XHJcbiAgICAgIC8vY29uc29sZS5sb2coXCJrZXlIYW5kbGVyXCIsIHRoaXMuc3RhcnRQb3MsIHBvcywgdmFsLCBjaGFyUHJlc3NlZCwgZXZlbnQpO1xyXG4gICAgICBcclxuICAgICAgbGV0IGNvbmZpZyA9IHRoaXMudHJpZ2dlckNoYXJzW2NoYXJQcmVzc2VkXTtcclxuICAgICAgaWYgKGNvbmZpZykge1xyXG4gICAgICAgIHRoaXMuYWN0aXZlQ29uZmlnID0gY29uZmlnO1xyXG4gICAgICAgIHRoaXMuc3RhcnRQb3MgPSBldmVudC5pbnB1dEV2ZW50ID8gcG9zIC0gMSA6IHBvcztcclxuICAgICAgICB0aGlzLnN0YXJ0Tm9kZSA9ICh0aGlzLmlmcmFtZSA/IHRoaXMuaWZyYW1lLmNvbnRlbnRXaW5kb3cuZ2V0U2VsZWN0aW9uKCkgOiB3aW5kb3cuZ2V0U2VsZWN0aW9uKCkpLmFuY2hvck5vZGU7XHJcbiAgICAgICAgdGhpcy5zZWFyY2hpbmcgPSB0cnVlO1xyXG4gICAgICAgIHRoaXMuc2VhcmNoU3RyaW5nID0gbnVsbDtcclxuICAgICAgICB0aGlzLnNob3dTZWFyY2hMaXN0KG5hdGl2ZUVsZW1lbnQpO1xyXG4gICAgICAgIHRoaXMudXBkYXRlU2VhcmNoTGlzdCgpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGlmIChjb25maWcucmV0dXJuVHJpZ2dlcikge1xyXG4gICAgICAgICAgdGhpcy5zZWFyY2hUZXJtLmVtaXQoY29uZmlnLnRyaWdnZXJDaGFyKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgIH1cclxuICAgICAgZWxzZSBpZiAodGhpcy5zdGFydFBvcyA+PSAwICYmIHRoaXMuc2VhcmNoaW5nKSB7XHJcbiAgICAgICAgaWYgKHBvcyA8PSB0aGlzLnN0YXJ0UG9zKSB7XHJcbiAgICAgICAgICB0aGlzLnNlYXJjaExpc3QuaGlkZGVuID0gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gaWdub3JlIHNoaWZ0IHdoZW4gcHJlc3NlZCBhbG9uZSwgYnV0IG5vdCB3aGVuIHVzZWQgd2l0aCBhbm90aGVyIGtleVxyXG4gICAgICAgIGVsc2UgaWYgKGV2ZW50LmtleUNvZGUgIT09IEtFWV9TSElGVCAmJlxyXG4gICAgICAgICAgIWV2ZW50Lm1ldGFLZXkgJiZcclxuICAgICAgICAgICFldmVudC5hbHRLZXkgJiZcclxuICAgICAgICAgICFldmVudC5jdHJsS2V5ICYmXHJcbiAgICAgICAgICBwb3MgPiB0aGlzLnN0YXJ0UG9zXHJcbiAgICAgICAgICApIHtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLmFjdGl2ZUNvbmZpZy5hbGxvd1NwYWNlICYmIGV2ZW50LmtleUNvZGUgPT09IEtFWV9TUEFDRSkge1xyXG4gICAgICAgICAgICAgIHRoaXMuc3RhcnRQb3MgPSAtMTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmIChldmVudC5rZXlDb2RlID09PSBLRVlfQkFDS1NQQUNFICYmIHBvcyA+IDApIHtcclxuICAgICAgICAgICAgICBwb3MtLTtcclxuICAgICAgICAgICAgICBpZiAocG9zID09IHRoaXMuc3RhcnRQb3MpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc3RvcFNlYXJjaCgpO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmICghdGhpcy5zZWFyY2hMaXN0LmhpZGRlbikge1xyXG4gICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgIGlmIChldmVudC5rZXlDb2RlID09PSBLRVlfVEFCIHx8IGV2ZW50LmtleUNvZGUgPT09IEtFWV9FTlRFUikge1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAvL2lzc3VlcyB3aXRoIHByaW1lTkcgZWRpdG9yLCB3aGVuIHByZXNzZWQgRU5URVJcclxuICAgICAgICAgICAgICAgIC8vdGhpcy5zdG9wRXZlbnQoZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICBpZiAoZXZlbnQua2V5Q29kZSA9PT0gS0VZX0VOVEVSICYmICFldmVudC53YXNDbGljayApIHtcclxuICAgICAgICAgICAgICAgICAgaWYocG9zIC0gMTcwID4gMCl7XHJcbiAgICAgICAgICAgICAgICAgICAgcG9zID0gcG9zIC0gMTcwO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRQb3MgPSB0aGlzLnN0YXJ0UG9zIC0gMTcwO1xyXG4gICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIC8vY29uc29sZS5sb2coJ2V2ZW50byBzdG9wcGVkICcgKyBldmVudC5rZXlDb2RlKTtcclxuICAgICAgICAgICAgICAgIC8vIGVtaXQgdGhlIHNlbGVjdGVkIGxpc3QgaXRlbVxyXG4gICAgICAgICAgICAgICAgdGhpcy5pdGVtU2VsZWN0ZWQuZW1pdCh0aGlzLnNlYXJjaExpc3QuYWN0aXZlSXRlbSk7XHJcbiAgICAgICAgICAgICAgICAvLyBvcHRpb25hbCBmdW5jdGlvbiB0byBmb3JtYXQgdGhlIHNlbGVjdGVkIGl0ZW0gYmVmb3JlIGluc2VydGluZyB0aGUgdGV4dFxyXG4gICAgICAgICAgICAgICAgY29uc3QgdGV4dCA9IHRoaXMuYWN0aXZlQ29uZmlnLm1lbnRpb25TZWxlY3QodGhpcy5zZWFyY2hMaXN0LmFjdGl2ZUl0ZW0sIHRoaXMuYWN0aXZlQ29uZmlnLnRyaWdnZXJDaGFyKTtcclxuICAgICAgICAgICAgICAgIC8vY29uc29sZS5sb2codGV4dCk7XHJcbiAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKG5hdGl2ZUVsZW1lbnQpO1xyXG4gICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZyh0aGlzLnN0YXJ0UG9zKTtcclxuICAgICAgICAgICAgICAgIC8vY29uc29sZS5sb2cocG9zKTtcclxuICAgICAgICAgICAgICAgIC8vIHZhbHVlIGlzIGluc2VydGVkIHdpdGhvdXQgYSB0cmFpbGluZyBzcGFjZSBmb3IgY29uc2lzdGVuY3lcclxuICAgICAgICAgICAgICAgIC8vIGJldHdlZW4gZWxlbWVudCB0eXBlcyAoZGl2IGFuZCBpZnJhbWUgZG8gbm90IHByZXNlcnZlIHRoZSBzcGFjZSlcclxuICAgICAgICAgICAgICAgIGluc2VydFZhbHVlKG5hdGl2ZUVsZW1lbnQsIHRoaXMuc3RhcnRQb3MsIHBvcywgdGhpcy5hY3RpdmVDb25maWcuaW5zZXJ0SFRNTCwgdGV4dCwgdGhpcy5pZnJhbWUpO1xyXG4gICAgICAgICAgICAgICAgLy8gZmlyZSBpbnB1dCBldmVudCBzbyBhbmd1bGFyIGJpbmRpbmdzIGFyZSB1cGRhdGVkXHJcbiAgICAgICAgICAgICAgICBpZiAoXCJjcmVhdGVFdmVudFwiIGluIGRvY3VtZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgIGxldCBldnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudChcIkhUTUxFdmVudHNcIik7XHJcbiAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmlmcmFtZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIGEgJ2NoYW5nZScgZXZlbnQgaXMgcmVxdWlyZWQgdG8gdHJpZ2dlciB0aW55bWNlIHVwZGF0ZXNcclxuICAgICAgICAgICAgICAgICAgICBldnQuaW5pdEV2ZW50KFwiY2hhbmdlXCIsIHRydWUsIGZhbHNlKTtcclxuICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBldnQuaW5pdEV2ZW50KFwiaW5wdXRcIiwgdHJ1ZSwgZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgIC8vIHRoaXMgc2VlbXMgYmFja3dhcmRzLCBidXQgZmlyZSB0aGUgZXZlbnQgZnJvbSB0aGlzIGVsZW1lbnRzIG5hdGl2ZUVsZW1lbnQgKG5vdCB0aGVcclxuICAgICAgICAgICAgICAgICAgLy8gb25lIHByb3ZpZGVkIHRoYXQgbWF5IGJlIGluIGFuIGlmcmFtZSwgYXMgaXQgd29uJ3QgYmUgcHJvcG9nYXRlKVxyXG4gICAgICAgICAgICAgICAgICB0aGlzLl9lbGVtZW50Lm5hdGl2ZUVsZW1lbnQuZGlzcGF0Y2hFdmVudChldnQpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdGhpcy5zdGFydFBvcyA9IC0xO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zdG9wU2VhcmNoKCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIGVsc2UgaWYgKGV2ZW50LmtleUNvZGUgPT09IEtFWV9FU0NBUEUpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc3RvcEV2ZW50KGV2ZW50KTtcclxuICAgICAgICAgICAgICAgIHRoaXMuc3RvcFNlYXJjaCgpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICBlbHNlIGlmIChldmVudC5rZXlDb2RlID09PSBLRVlfRE9XTikge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zdG9wRXZlbnQoZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zZWFyY2hMaXN0LmFjdGl2YXRlTmV4dEl0ZW0oKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgZWxzZSBpZiAoZXZlbnQua2V5Q29kZSA9PT0gS0VZX1VQKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnN0b3BFdmVudChldmVudCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNlYXJjaExpc3QuYWN0aXZhdGVQcmV2aW91c0l0ZW0oKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGlmIChjaGFyUHJlc3NlZC5sZW5ndGghPTEgJiYgZXZlbnQua2V5Q29kZSE9S0VZX0JBQ0tTUEFDRSkge1xyXG4gICAgICAgICAgICAgIHRoaXMuc3RvcEV2ZW50KGV2ZW50KTtcclxuICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5zZWFyY2hpbmcpIHtcclxuICAgICAgICAgICAgICBsZXQgbWVudGlvbiA9IHZhbC5zdWJzdHJpbmcodGhpcy5zdGFydFBvcyArIDEsIHBvcyk7XHJcbiAgICAgICAgICAgICAgaWYgKGV2ZW50LmtleUNvZGUgIT09IEtFWV9CQUNLU1BBQ0UgJiYgIWV2ZW50LmlucHV0RXZlbnQpIHtcclxuICAgICAgICAgICAgICAgIG1lbnRpb24gKz0gY2hhclByZXNzZWQ7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIHRoaXMuc2VhcmNoU3RyaW5nID0gbWVudGlvbjtcclxuICAgICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVDb25maWcucmV0dXJuVHJpZ2dlcikge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgdHJpZ2dlckNoYXIgPSAodGhpcy5zZWFyY2hTdHJpbmcgfHwgZXZlbnQua2V5Q29kZSA9PT0gS0VZX0JBQ0tTUEFDRSkgPyB2YWwuc3Vic3RyaW5nKHRoaXMuc3RhcnRQb3MsIHRoaXMuc3RhcnRQb3MgKyAxKSA6ICcnO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zZWFyY2hUZXJtLmVtaXQodHJpZ2dlckNoYXIgKyB0aGlzLnNlYXJjaFN0cmluZyk7XHJcbiAgICAgICAgICAgICAgfSBcclxuICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2VhcmNoVGVybS5lbWl0KHRoaXMuc2VhcmNoU3RyaW5nKTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgdGhpcy51cGRhdGVTZWFyY2hMaXN0KCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgXHJcbiAgICAgIC8vIGV4cG9zZWQgZm9yIGV4dGVybmFsIGNhbGxzIHRvIG9wZW4gdGhlIG1lbnRpb24gbGlzdCwgZS5nLiBieSBjbGlja2luZyBhIGJ1dHRvblxyXG4gICAgICBwdWJsaWMgc3RhcnRTZWFyY2godHJpZ2dlckNoYXI/OiBzdHJpbmcsIG5hdGl2ZUVsZW1lbnQ6IEhUTUxJbnB1dEVsZW1lbnQgPSB0aGlzLl9lbGVtZW50Lm5hdGl2ZUVsZW1lbnQpIHtcclxuICAgICAgICB0cmlnZ2VyQ2hhciA9IHRyaWdnZXJDaGFyIHx8IHRoaXMubWVudGlvbkNvbmZpZy50cmlnZ2VyQ2hhciB8fCB0aGlzLkRFRkFVTFRfQ09ORklHLnRyaWdnZXJDaGFyO1xyXG4gICAgICAgIGNvbnN0IHBvcyA9IGdldENhcmV0UG9zaXRpb24obmF0aXZlRWxlbWVudCwgdGhpcy5pZnJhbWUpO1xyXG4gICAgICAgIGluc2VydFZhbHVlKG5hdGl2ZUVsZW1lbnQsIHBvcywgcG9zLCB0aGlzLmFjdGl2ZUNvbmZpZy5pbnNlcnRIVE1MLCB0cmlnZ2VyQ2hhciwgdGhpcy5pZnJhbWUpO1xyXG4gICAgICAgIHRoaXMua2V5SGFuZGxlcih7IGtleTogdHJpZ2dlckNoYXIsIGlucHV0RXZlbnQ6IHRydWUgfSwgbmF0aXZlRWxlbWVudCk7XHJcbiAgICAgIH1cclxuICAgICAgXHJcbiAgICAgIHN0b3BTZWFyY2goKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuc2VhcmNoTGlzdCAmJiAhdGhpcy5zZWFyY2hMaXN0LmhpZGRlbikge1xyXG4gICAgICAgICAgdGhpcy5zZWFyY2hMaXN0LmhpZGRlbiA9IHRydWU7XHJcbiAgICAgICAgICB0aGlzLmNsb3NlZC5lbWl0KCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuYWN0aXZlQ29uZmlnID0gbnVsbDtcclxuICAgICAgICB0aGlzLnNlYXJjaGluZyA9IGZhbHNlO1xyXG4gICAgICB9XHJcbiAgICAgIFxyXG4gICAgICB1cGRhdGVTZWFyY2hMaXN0KCkge1xyXG4gICAgICAgIGxldCBtYXRjaGVzOiBhbnlbXSA9IFtdO1xyXG4gICAgICAgIGlmICh0aGlzLmFjdGl2ZUNvbmZpZyAmJiB0aGlzLmFjdGl2ZUNvbmZpZy5pdGVtcykge1xyXG4gICAgICAgICAgbGV0IG9iamVjdHMgPSB0aGlzLmFjdGl2ZUNvbmZpZy5pdGVtcztcclxuICAgICAgICAgIC8vIGRpc2FibGluZyB0aGUgc2VhcmNoIHJlbGllcyBvbiB0aGUgYXN5bmMgb3BlcmF0aW9uIHRvIGRvIHRoZSBmaWx0ZXJpbmdcclxuICAgICAgICAgIGlmICghdGhpcy5hY3RpdmVDb25maWcuZGlzYWJsZVNlYXJjaCAmJiB0aGlzLnNlYXJjaFN0cmluZyAmJiB0aGlzLmFjdGl2ZUNvbmZpZy5sYWJlbEtleSkge1xyXG4gICAgICAgICAgICBsZXQgc2VhcmNoU3RyaW5nTG93ZXJDYXNlID0gdGhpcy5zZWFyY2hTdHJpbmcudG9Mb3dlckNhc2UoKTtcclxuICAgICAgICAgICAgb2JqZWN0cyA9IG9iamVjdHMuZmlsdGVyKGUgPT4gZVt0aGlzLmFjdGl2ZUNvbmZpZy5sYWJlbEtleV0udG9Mb3dlckNhc2UoKS5zdGFydHNXaXRoKHNlYXJjaFN0cmluZ0xvd2VyQ2FzZSkpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgbWF0Y2hlcyA9IG9iamVjdHM7XHJcbiAgICAgICAgICBpZiAodGhpcy5hY3RpdmVDb25maWcubWF4SXRlbXMgPiAwKSB7XHJcbiAgICAgICAgICAgIG1hdGNoZXMgPSBtYXRjaGVzLnNsaWNlKDAsIHRoaXMuYWN0aXZlQ29uZmlnLm1heEl0ZW1zKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gdXBkYXRlIHRoZSBzZWFyY2ggbGlzdFxyXG4gICAgICAgIGlmICh0aGlzLnNlYXJjaExpc3QpIHtcclxuICAgICAgICAgIHRoaXMuc2VhcmNoTGlzdC5pdGVtcyA9IG1hdGNoZXM7XHJcbiAgICAgICAgICB0aGlzLnNlYXJjaExpc3QuaGlkZGVuID0gbWF0Y2hlcy5sZW5ndGggPT0gMDtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgXHJcbiAgICAgIHNob3dTZWFyY2hMaXN0KG5hdGl2ZUVsZW1lbnQ6IEhUTUxJbnB1dEVsZW1lbnQpIHtcclxuICAgICAgICB0aGlzLm9wZW5lZC5lbWl0KCk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgaWYgKHRoaXMuc2VhcmNoTGlzdCA9PSBudWxsKSB7XHJcbiAgICAgICAgICBsZXQgY29tcG9uZW50RmFjdG9yeSA9IHRoaXMuX2NvbXBvbmVudFJlc29sdmVyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KE1lbnRpb25MaXN0Q29tcG9uZW50KTtcclxuICAgICAgICAgIGxldCBjb21wb25lbnRSZWYgPSB0aGlzLl92aWV3Q29udGFpbmVyUmVmLmNyZWF0ZUNvbXBvbmVudChjb21wb25lbnRGYWN0b3J5KTtcclxuICAgICAgICAgIHRoaXMuc2VhcmNoTGlzdCA9IGNvbXBvbmVudFJlZi5pbnN0YW5jZTtcclxuICAgICAgICAgIHRoaXMuc2VhcmNoTGlzdC5pdGVtVGVtcGxhdGUgPSB0aGlzLm1lbnRpb25MaXN0VGVtcGxhdGU7XHJcbiAgICAgICAgICBcclxuICAgICAgICAgIGNvbXBvbmVudFJlZi5pbnN0YW5jZVsnaXRlbUNsaWNrJ10uc3Vic2NyaWJlKCgpID0+IHtcclxuICAgICAgICAgICAgbmF0aXZlRWxlbWVudC5mb2N1cygpO1xyXG4gICAgICAgICAgICBsZXQgZmFrZUtleWRvd24gPSB7IGtleTogJ0VudGVyJywga2V5Q29kZTogS0VZX0VOVEVSLCB3YXNDbGljazogdHJ1ZSB9O1xyXG4gICAgICAgICAgICB0aGlzLmtleUhhbmRsZXIoZmFrZUtleWRvd24sIG5hdGl2ZUVsZW1lbnQpO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuc2VhcmNoTGlzdC5sYWJlbEtleSA9IHRoaXMuYWN0aXZlQ29uZmlnLmxhYmVsS2V5O1xyXG4gICAgICAgIHRoaXMuc2VhcmNoTGlzdC5kcm9wVXAgPSB0aGlzLmFjdGl2ZUNvbmZpZy5kcm9wVXA7XHJcbiAgICAgICAgdGhpcy5zZWFyY2hMaXN0LnN0eWxlT2ZmID0gdGhpcy5tZW50aW9uQ29uZmlnLmRpc2FibGVTdHlsZTtcclxuICAgICAgICB0aGlzLnNlYXJjaExpc3QuYWN0aXZlSW5kZXggPSAwO1xyXG4gICAgICAgIHRoaXMuc2VhcmNoTGlzdC5wb3NpdGlvbihuYXRpdmVFbGVtZW50LCB0aGlzLmlmcmFtZSk7XHJcbiAgICAgICAgd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB0aGlzLnNlYXJjaExpc3QucmVzZXQoKSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgICJdfQ==