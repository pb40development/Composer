// DOM element manipulation functions...
//
function setValue(el, value) {
    if (isInputOrTextAreaElement(el)) {
        el.value = value;
    }
    else {
        el.textContent = value;
    }
}
export function getValue(el) {
    return isInputOrTextAreaElement(el) ? el.value : el.textContent;
}
export function insertValue(el, start, end, insertHTML, text, iframe, noRecursion = false) {
    if (isTextElement(el)) {
        let val = getValue(el);
        setValue(el, val.substring(0, start) + text + val.substring(end, val.length));
        setCaretPosition(el, start + text.length, iframe);
    }
    else if (!noRecursion) {
        let selObj = getWindowSelection(iframe);
        //console.log(selObj);
        if (selObj && selObj.rangeCount > 0) {
            // var selRange = selObj.getRangeAt(0);
            // var position = selRange.startOffset;
            // var anchorNode = selObj.anchorNode;
            // if (text.endsWith(' ')) {
            //   text = text.substring(0, text.length-1) + '\xA0';
            // }
            // insertValue(<HTMLInputElement>anchorNode, position - (end - start), position, text, iframe, true);
            if (insertHTML) {
                insertElement(selObj, start, end, text, iframe);
            }
            else {
                var selRange = selObj.getRangeAt(0);
                var position = selRange.startOffset;
                var anchorNode = selObj.anchorNode;
                // if (text.endsWith(' ')) {
                //   text = text.substring(0, text.length-1) + '\xA0';
                // }
                insertValue(anchorNode, position - (end - start), position, insertHTML, text, iframe, true);
            }
        }
    }
}
function makeAngularElements(el) {
    if (!(el instanceof HTMLElement)) {
        return;
    }
    el.setAttribute("_ngcontent-c0", '');
    for (let i in el.children) {
        makeAngularElements(el.children[i]);
    }
}
function insertElement(selObj, start, end, text, iframe) {
    //console.log(start, end);
    if (!(text instanceof HTMLElement)) {
        var e = getDocument(iframe).createElement("span");
        e.innerHTML = text;
        text = e;
    }
    //make the element an angular element
    makeAngularElements(text);
    var anchorNode = selObj.anchorNode;
    //var anchorNode = selObj.anchorNode.previousSibling;
    //debugger;
    //console.log(selObj);
    //console.log(anchorNode);
    //console.log(anchorNode.nodeValue);
    //Get the text that preceeded and followed what was typed as part of the autocomplete
    var beforeString = '';
    var afterString = '';
    var isEnterKey = false;
    if (anchorNode.hasChildNodes() && anchorNode.firstChild.parentElement.innerHTML == '<br>') {
        isEnterKey = true;
        var contentHTML = anchorNode.parentElement.innerHTML;
        //var qtyLineBreaks = contentHTML.substring(0, ) .split('')
        var contentToReplace = anchorNode.parentElement.innerText.substring(start, end);
        contentToReplace = contentToReplace.replace('\n', '');
        if (contentToReplace.indexOf('@') == -1) {
            contentToReplace = '@' + contentToReplace;
        }
        if (text.innerHTML.indexOf('@') == -1) {
            text.innerHTML = '&#64;' + text.innerHTML;
        }
        contentHTML = contentHTML.replace(contentToReplace, text.innerHTML);
        anchorNode.parentElement.innerHTML = contentHTML;
    }
    else {
        if (anchorNode.nodeValue) {
            //console.log(anchorNode);
            beforeString = anchorNode.nodeValue.substr(0, start);
            afterString = anchorNode.nodeValue.substring(end);
        }
        else if (anchorNode.textContent) {
            beforeString = anchorNode.textContent.substr(0, start);
            afterString = anchorNode.textContent.substring(end);
        }
        else {
            beforeString = '';
            afterString = text.innerText.substring(end);
        }
        //console.log("beforeString:",beforeString);
        //console.log("afterString:",afterString);
        //removing previous typed search string
        var positionChar = beforeString.lastIndexOf('@');
        //console.log(" positionChar:", positionChar);
        if (positionChar < 0) {
            beforeString = beforeString + '@';
            var positionChar = beforeString.lastIndexOf('@');
            //console.log(" beforeString 2:", beforeString);
        }
        beforeString = beforeString.substring(0, positionChar + 1);
        //console.log("beforeString final:",beforeString);
        //Remove the text
        if (isEnterKey) {
            //console.log(anchorNode.parentElement.innerHTML);
            anchorNode.parentElement.innerText = anchorNode.parentElement.innerText.replace('@jos', '');
            anchorNode.removeChild(anchorNode.firstChild); // .previousSibling.nodeValue = "";
            //anchorNode.previousSibling.textContent = "";
        }
        else {
            anchorNode.nodeValue = "";
            anchorNode.textContent = "";
        }
        //Create spans for the preceeding text & following text
        let beforeEl = getDocument(iframe).createElement("span");
        beforeEl.innerText = beforeString;
        let afterEl = getDocument(iframe).createElement("span");
        afterEl.innerText = afterString;
        //Insert the spans + the mention element
        //debugger;
        anchorNode.parentNode.insertBefore(afterEl, anchorNode.nextSibling);
        anchorNode.parentNode.insertBefore(text, anchorNode.nextSibling);
        anchorNode.parentNode.insertBefore(beforeEl, anchorNode.nextSibling);
        //Create a range located ater the mention
        let range = getDocument(iframe).createRange();
        range.selectNode(afterEl);
        range.setStart(afterEl, 0);
        range.setEnd(afterEl, 0);
        //Move the cursor to that spot
        range.collapse(false);
        selObj.removeAllRanges();
        selObj.addRange(range);
    }
    //var htmlNode = beforeEl.innerHTML +  text.innerHTML + afterEl.innerHTML;
    //anchorNode.parentElement.innerHTML =  htmlNode;
    //anchorNode.parentNode.insertBefore(text, anchorNode.nextSibling);
    //anchorNode.parentNode.insertBefore() .insertBefore(beforeEl, anchorNode.nextSibling);
    //return;
}
export function isInputOrTextAreaElement(el) {
    return el != null && (el.nodeName == 'INPUT' || el.nodeName == 'TEXTAREA');
}
;
export function isTextElement(el) {
    return el != null && (el.nodeName == 'INPUT' || el.nodeName == 'TEXTAREA' || el.nodeName == '#text');
}
;
export function setCaretPosition(el, pos, iframe = null) {
    //console.log("setCaretPosition", pos, el, iframe==null);
    if (isInputOrTextAreaElement(el) && el.selectionStart) {
        //el.focus();
        el.setSelectionRange(pos, pos);
    }
    else {
        let range = getDocument(iframe).createRange();
        range.setStart(el, pos);
        range.collapse(true);
        let sel = getWindowSelection(iframe);
        sel.removeAllRanges();
        sel.addRange(range);
    }
}
export function getCaretPosition(el, iframe = null) {
    //console.log("getCaretPosition", el);
    if (isInputOrTextAreaElement(el)) {
        var val = el.value;
        return val.slice(0, el.selectionStart).length;
    }
    else {
        var selObj = getWindowSelection(iframe); //window.getSelection();
        if (selObj.rangeCount > 0) {
            var selRange = selObj.getRangeAt(0);
            var preCaretRange = selRange.cloneRange();
            preCaretRange.selectNodeContents(el);
            preCaretRange.setEnd(selRange.endContainer, selRange.endOffset);
            var position = preCaretRange.toString().length;
            return position;
        }
    }
}
// Based on ment.io functions...
//
function getDocument(iframe) {
    if (!iframe) {
        return document;
    }
    else {
        return iframe.contentWindow.document;
    }
}
function getWindowSelection(iframe) {
    if (!iframe) {
        //console.log(window.getSelection());
        return window.getSelection();
    }
    else {
        return iframe.contentWindow.getSelection();
    }
}
export function getContentEditableCaretCoords(ctx) {
    let markerTextChar = '\ufeff';
    let markerId = 'sel_' + new Date().getTime() + '_' + Math.random().toString().substr(2);
    let doc = getDocument(ctx ? ctx.iframe : null);
    let sel = getWindowSelection(ctx ? ctx.iframe : null);
    let prevRange = sel.getRangeAt(0);
    // create new range and set postion using prevRange
    let range = doc.createRange();
    range.setStart(sel.anchorNode, prevRange.startOffset);
    range.setEnd(sel.anchorNode, prevRange.startOffset);
    range.collapse(false);
    // Create the marker element containing a single invisible character
    // using DOM methods and insert it at the position in the range
    let markerEl = doc.createElement('span');
    markerEl.id = markerId;
    markerEl.appendChild(doc.createTextNode(markerTextChar));
    range.insertNode(markerEl);
    sel.removeAllRanges();
    sel.addRange(prevRange);
    let coordinates = {
        left: 0,
        top: markerEl.offsetHeight
    };
    localToRelativeCoordinates(ctx, markerEl, coordinates);
    markerEl.parentNode.removeChild(markerEl);
    return coordinates;
}
function localToRelativeCoordinates(ctx, element, coordinates) {
    let obj = element;
    let iframe = ctx ? ctx.iframe : null;
    while (obj) {
        if (ctx.parent != null && ctx.parent == obj) {
            break;
        }
        coordinates.left += obj.offsetLeft + obj.clientLeft;
        coordinates.top += obj.offsetTop + obj.clientTop;
        obj = obj.offsetParent;
        if (!obj && iframe) {
            obj = iframe;
            iframe = null;
        }
    }
    obj = element;
    iframe = ctx ? ctx.iframe : null;
    while (obj !== getDocument(null).body && obj != null) {
        if (ctx.parent != null && ctx.parent == obj) {
            break;
        }
        if (obj.scrollTop && obj.scrollTop > 0) {
            coordinates.top -= obj.scrollTop;
        }
        if (obj.scrollLeft && obj.scrollLeft > 0) {
            coordinates.left -= obj.scrollLeft;
        }
        obj = obj.parentNode;
        if (!obj && iframe) {
            obj = iframe;
            iframe = null;
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVudGlvbi11dGlscy5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2tsLWFuZ3VsYXItbWVudGlvbnMvIiwic291cmNlcyI6WyJsaWIvbWVudGlvbi11dGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSx3Q0FBd0M7QUFDeEMsRUFBRTtBQUVGLFNBQVMsUUFBUSxDQUFDLEVBQW9CLEVBQUUsS0FBVTtJQUNoRCxJQUFJLHdCQUF3QixDQUFDLEVBQUUsQ0FBQyxFQUFFO1FBQ2hDLEVBQUUsQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO0tBQ2xCO1NBQ0k7UUFDSCxFQUFFLENBQUMsV0FBVyxHQUFHLEtBQUssQ0FBQztLQUN4QjtBQUNILENBQUM7QUFFRCxNQUFNLFVBQVUsUUFBUSxDQUFDLEVBQW9CO0lBQzNDLE9BQU8sd0JBQXdCLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxXQUFXLENBQUM7QUFDbEUsQ0FBQztBQUVELE1BQU0sVUFBVSxXQUFXLENBQ3pCLEVBQW9CLEVBQ3BCLEtBQWEsRUFDYixHQUFXLEVBQ1gsVUFBbUIsRUFDbkIsSUFBUyxFQUNULE1BQXlCLEVBQ3pCLGNBQXVCLEtBQUs7SUFHMUIsSUFBSSxhQUFhLENBQUMsRUFBRSxDQUFDLEVBQUU7UUFDckIsSUFBSSxHQUFHLEdBQUcsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3ZCLFFBQVEsQ0FBQyxFQUFFLEVBQUUsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLEdBQUcsSUFBSSxHQUFHLEdBQUcsQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1FBQzlFLGdCQUFnQixDQUFDLEVBQUUsRUFBRSxLQUFLLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUMsQ0FBQztLQUNuRDtTQUNJLElBQUksQ0FBQyxXQUFXLEVB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LElBQUksR0FBRyxDQUFDLFVBQVUsQ0FBQztTQUNwQztRQUNELEdBQUcsR0FBZ0IsR0FBRyxDQUFDLFVBQVUsQ0FBQztRQUNsQyxJQUFJLENBQUMsR0FBRyxJQUFJLE1BQU0sRUFBRTtZQUNsQixHQUFHLEdBQUcsTUFBTSxDQUFDO1lBQ2IsTUFBTSxHQUFHLElBQUksQ0FBQztTQUNmO0tBQ0Y7QUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gRE9NIGVsZW1lbnQgbWFuaXB1bGF0aW9uIGZ1bmN0aW9ucy4uLlxyXG4vL1xyXG5cclxuZnVuY3Rpb24gc2V0VmFsdWUoZWw6IEhUTUxJbnB1dEVsZW1lbnQsIHZhbHVlOiBhbnkpIHtcclxuICBpZiAoaXNJbnB1dE9yVGV4dEFyZWFFbGVtZW50KGVsKSkge1xyXG4gICAgZWwudmFsdWUgPSB2YWx1ZTtcclxuICB9XHJcbiAgZWxzZSB7XHJcbiAgICBlbC50ZXh0Q29udGVudCA9IHZhbHVlO1xyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldFZhbHVlKGVsOiBIVE1MSW5wdXRFbGVtZW50KSB7XHJcbiAgcmV0dXJuIGlzSW5wdXRPclRleHRBcmVhRWxlbWVudChlbCkgPyBlbC52YWx1ZSA6IGVsLnRleHRDb250ZW50O1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaW5zZXJ0VmFsdWUoXHJcbiAgZWw6IEhUTUxJbnB1dEVsZW1lbnQsXHJcbiAgc3RhcnQ6IG51bWJlcixcclxuICBlbmQ6IG51bWJlcixcclxuICBpbnNlcnRIVE1MOiBib29sZWFuLFxyXG4gIHRleHQ6IGFueSxcclxuICBpZnJhbWU6IEhUTUxJRnJhbWVFbGVtZW50LFxyXG4gIG5vUmVjdXJzaW9uOiBib29sZWFuID0gZmFsc2VcclxuICApIHtcclxuICAgIFxyXG4gICAgaWYgKGlzVGV4dEVsZW1lbnQoZWwpKSB7XHJcbiAgICAgIGxldCB2YWwgPSBnZXRWYWx1ZShlbCk7XHJcbiAgICAgIHNldFZhbHVlKGVsLCB2YWwuc3Vic3RyaW5nKDAsIHN0YXJ0KSArIHRleHQgKyB2YWwuc3Vic3RyaW5nKGVuZCwgdmFsLmxlbmd0aCkpO1xyXG4gICAgICBzZXRDYXJldFBvc2l0aW9uKGVsLCBzdGFydCArIHRleHQubGVuZ3RoLCBpZnJhbWUpO1xyXG4gICAgfVxyXG4gICAgZWxzZSBpZiAoIW5vUmVjdXJzaW9uKSB7XHJcbiAgICAgIGxldCBzZWxPYmo6IFNlbGVjdGlvbiA9IGdldFdpbmRvd1NlbGVjdGlvbihpZnJhbWUpO1xyXG4gICAgICAvL2NvbnNvbGUubG9nKHNlbE9iaik7XHJcbiAgICAgIGlmIChzZWxPYmogJiYgc2VsT2JqLnJhbmdlQ291bnQgPiAwKSB7XHJcbiAgICAgICAgLy8gdmFyIHNlbFJhbmdlID0gc2VsT2JqLmdldFJhbmdlQXQoMCk7XHJcbiAgICAgICAgLy8gdmFyIHBvc2l0aW9uID0gc2VsUmFuZ2Uuc3RhcnRPZmZzZXQ7XHJcbiAgICAgICAgLy8gdmFyIGFuY2hvck5vZGUgPSBzZWxPYmouYW5jaG9yTm9kZTtcclxuICAgICAgICAvLyBpZiAodGV4dC5lbmRzV2l0aCgnICcpKSB7XHJcbiAgICAgICAgLy8gICB0ZXh0ID0gdGV4dC5zdWJzdHJpbmcoMCwgdGV4dC5sZW5ndGgtMSkgKyAnXFx4QTAnO1xyXG4gICAgICAgIC8vIH1cclxuICAgICAgICAvLyBpbnNlcnRWYWx1ZSg8SFRNTElucHV0RWxlbWVudD5hbmNob3JOb2RlLCBwb3NpdGlvbiAtIChlbmQgLSBzdGFydCksIHBvc2l0aW9uLCB0ZXh0LCBpZnJhbWUsIHRydWUpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGlmIChpbnNlcnRIVE1MKSB7XHJcbiAgICAgICAgICBpbnNlcnRFbGVtZW50KHNlbE9iaiwgc3RhcnQsIGVuZCwgdGV4dCwgaWZyYW1lKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICB2YXIgc2VsUmFuZ2UgPSBzZWxPYmouZ2V0UmFuZ2VBdCgwKTtcclxuICAgICAgICAgIHZhciBwb3NpdGlvbiA9IHNlbFJhbmdlLnN0YXJ0T2Zmc2V0O1xyXG4gICAgICAgICAgdmFyIGFuY2hvck5vZGUgPSBzZWxPYmouYW5jaG9yTm9kZTtcclxuICAgICAgICAgIC8vIGlmICh0ZXh0LmVuZHNXaXRoKCcgJykpIHtcclxuICAgICAgICAgIC8vICAgdGV4dCA9IHRleHQuc3Vic3RyaW5nKDAsIHRleHQubGVuZ3RoLTEpICsgJ1xceEEwJztcclxuICAgICAgICAgIC8vIH1cclxuICAgICAgICAgIFxyXG4gICAgICAgICAgaW5zZXJ0VmFsdWUoPEhUTUxJbnB1dEVsZW1lbnQ+YW5jaG9yTm9kZSwgcG9zaXRpb24gLSAoZW5kIC0gc3RhcnQpLCBwb3NpdGlvbiwgaW5zZXJ0SFRNTCwgdGV4dCwgaWZyYW1lLCB0cnVlKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcbiAgXHJcbiAgZnVuY3Rpb24gbWFrZUFuZ3VsYXJFbGVtZW50cyhlbCkge1xyXG4gICAgaWYgKCEoZWwgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgZWwuc2V0QXR0cmlidXRlKFwiX25nY29udGVudC1jMFwiLCAnJyk7XHJcbiAgICBmb3IgKGxldCBpIGluIGVsLmNoaWxkcmVuKSB7XHJcbiAgICAgIG1ha2VBbmd1bGFyRWxlbWVudHMoZWwuY2hpbGRyZW5baV0pXHJcbiAgICB9XHJcbiAgfVxyXG4gIFxyXG4gIFxyXG4gIGZ1bmN0aW9uIGluc2VydEVsZW1lbnQoXHJcbiAgICBzZWxPYmo6IFNlbGVjdGlvbixcclxuICAgIHN0YXJ0OiBudW1iZXIsXHJcbiAgICBlbmQ6IG51bWJlcixcclxuICAgIHRleHQ6IEhUTUxFbGVtZW50LFxyXG4gICAgaWZyYW1lOiBIVE1MSUZyYW1lRWxlbWVudFxyXG4gICAgKSB7XHJcbiAgICAgIFxyXG4gICAgICAvL2NvbnNvbGUubG9nKHN0YXJ0LCBlbmQpO1xyXG4gICAgICBcclxuICAgICAgaWYgKCEodGV4dCBpbnN0YW5jZW9mIEhUTUxFbGVtZW50KSkge1xyXG4gICAgICAgIHZhciBlID0gZ2V0RG9jdW1lbnQoaWZyYW1lKS5jcmVhdGVFbGVtZW50KFwic3BhblwiKTtcclxuICAgICAgICBlLmlubmVySFRNTCA9IHRleHQ7XHJcbiAgICAgICAgdGV4dCA9IGU7XHJcbiAgICAgIH1cclxuICAgICAgXHJcbiAgICAgIC8vbWFrZSB0aGUgZWxlbWVudCBhbiBhbmd1bGFyIGVsZW1lbnRcclxuICAgICAgbWFrZUFuZ3VsYXJFbGVtZW50cyh0ZXh0KTtcclxuICAgICAgXHJcbiAgICAgIFxyXG4gICAgICB2YXIgYW5jaG9yTm9kZSA9IHNlbE9iai5hbmNob3JOb2RlO1xyXG4gICAgICAvL3ZhciBhbmNob3JOb2RlID0gc2VsT2JqLmFuY2hvck5vZGUucHJldmlvdXNTaWJsaW5nO1xyXG4gICAgICAvL2RlYnVnZ2VyO1xyXG4gICAgICBcclxuICAgICAgLy9jb25zb2xlLmxvZyhzZWxPYmopO1xyXG4gICAgICAvL2NvbnNvbGUubG9nKGFuY2hvck5vZGUpO1xyXG4gICAgICAvL2NvbnNvbGUubG9nKGFuY2hvck5vZGUubm9kZVZhbHVlKTtcclxuICAgICAgLy9HZXQgdGhlIHRleHQgdGhhdCBwcmVjZWVkZWQgYW5kIGZvbGxvd2VkIHdoYXQgd2FzIHR5cGVkIGFzIHBhcnQgb2YgdGhlIGF1dG9jb21wbGV0ZVxyXG4gICAgICB2YXIgYmVmb3JlU3RyaW5nID0gJyc7XHJcbiAgICAgIHZhciBhZnRlclN0cmluZyA9ICcnO1xyXG4gICAgICB2YXIgaXNFbnRlcktleSA9IGZhbHNlO1xyXG4gICAgICBcclxuICAgICAgaWYoYW5jaG9yTm9kZS5oYXNDaGlsZE5vZGVzKCkgJiYgYW5jaG9yTm9kZS5maXJzdENoaWxkLnBhcmVudEVsZW1lbnQuaW5uZXJIVE1MID09ICc8YnI+JykgIHtcclxuICAgICAgICBpc0VudGVyS2V5ID0gdHJ1ZTtcclxuICAgICAgICBcclxuICAgICAgICB2YXIgY29udGVudEhUTUwgPSBhbmNob3JOb2RlLnBhcmVudEVsZW1lbnQuaW5uZXJIVE1MO1xyXG4gICAgICAgIC8vdmFyIHF0eUxpbmVCcmVha3MgPSBjb250ZW50SFRNTC5zdWJzdHJpbmcoMCwgKSAuc3BsaXQoJycpXHJcbiAgICAgICAgdmFyIGNvbnRlbnRUb1JlcGxhY2UgPSBhbmNob3JOb2RlLnBhcmVudEVsZW1lbnQuaW5uZXJUZXh0LnN1YnN0cmluZyhzdGFydCwgZW5kKTtcclxuICAgICAgICBjb250ZW50VG9SZXBsYWNlID0gIGNvbnRlbnRUb1JlcGxhY2UucmVwbGFjZSgnXFxuJywnJyk7XHJcblxyXG4gICAgICAgIGlmKGNvbnRlbnRUb1JlcGxhY2UuaW5kZXhPZignQCcpID09IC0xKXtcclxuICAgICAgICAgIGNvbnRlbnRUb1JlcGxhY2UgPSAnQCcgKyBjb250ZW50VG9SZXBsYWNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZih0ZXh0LmlubmVySFRNTC5pbmRleE9mKCdAJykgPT0gLTEgKXtcclxuICAgICAgICAgIHRleHQuaW5uZXJIVE1MID0gJyYjNjQ7JyArIHRleHQuaW5uZXJIVE1MO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb250ZW50SFRNTCA9IGNvbnRlbnRIVE1MLnJlcGxhY2UoY29udGVudFRvUmVwbGFjZSwgdGV4dC5pbm5lckhUTUwpO1xyXG5cclxuICAgICAgICBhbmNob3JOb2RlLnBhcmVudEVsZW1lbnQuaW5uZXJIVE1MID0gY29udGVudEhUTUw7XHJcbiAgICAgICAgXHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgXHJcbiAgICAgICAgIGlmKGFuY2hvck5vZGUubm9kZVZhbHVlKXtcclxuICAgICAgICAgIC8vY29uc29sZS5sb2coYW5jaG9yTm9kZSk7XHJcbiAgICAgICAgICBiZWZvcmVTdHJpbmcgPSBhbmNob3JOb2RlLm5vZGVWYWx1ZS5zdWJzdHIoMCwgc3RhcnQpO1xyXG4gICAgICAgICAgYWZ0ZXJTdHJpbmcgPSBhbmNob3JOb2RlLm5vZGVWYWx1ZS5zdWJzdHJpbmcoZW5kKTsgIFxyXG4gICAgICAgIH0gZWxzZSBpZihhbmNob3JOb2RlLnRleHRDb250ZW50KXtcclxuICAgICAgICAgIGJlZm9yZVN0cmluZyA9IGFuY2hvck5vZGUudGV4dENvbnRlbnQuc3Vic3RyKDAsIHN0YXJ0KTtcclxuICAgICAgICAgIGFmdGVyU3RyaW5nID0gYW5jaG9yTm9kZS50ZXh0Q29udGVudC5zdWJzdHJpbmcoZW5kKTsgIFxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBiZWZvcmVTdHJpbmcgPSAnJztcclxuICAgICAgICAgIGFmdGVyU3RyaW5nID0gdGV4dC5pbm5lclRleHQuc3Vic3RyaW5nKGVuZCk7ICBcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgLy9jb25zb2xlLmxvZyhcImJlZm9yZVN0cmluZzpcIixiZWZvcmVTdHJpbmcpO1xyXG4gICAgICAgIC8vY29uc29sZS5sb2coXCJhZnRlclN0cmluZzpcIixhZnRlclN0cmluZyk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgLy9yZW1vdmluZyBwcmV2aW91cyB0eXBlZCBzZWFyY2ggc3RyaW5nXHJcbiAgICAgICAgdmFyIHBvc2l0aW9uQ2hhciA9IGJlZm9yZVN0cmluZy5sYXN0SW5kZXhPZignQCcpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIC8vY29uc29sZS5sb2coXCIgcG9zaXRpb25DaGFyOlwiLCBwb3NpdGlvbkNoYXIpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGlmKHBvc2l0aW9uQ2hhciA8IDApIHtcclxuICAgICAgICAgIGJlZm9yZVN0cmluZyA9IGJlZm9yZVN0cmluZyArICdAJztcclxuICAgICAgICAgIHZhciBwb3NpdGlvbkNoYXIgPSBiZWZvcmVTdHJpbmcubGFzdEluZGV4T2YoJ0AnKTtcclxuICAgICAgICAgIC8vY29uc29sZS5sb2coXCIgYmVmb3JlU3RyaW5nIDI6XCIsIGJlZm9yZVN0cmluZyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIFxyXG4gICAgICAgIGJlZm9yZVN0cmluZyA9IGJlZm9yZVN0cmluZy5zdWJzdHJpbmcoMCwgIHBvc2l0aW9uQ2hhciArIDEpO1xyXG4gICAgICAgIC8vY29uc29sZS5sb2coXCJiZWZvcmVTdHJpbmcgZmluYWw6XCIsYmVmb3JlU3RyaW5nKTtcclxuICAgICAgICBcclxuICAgICAgICAvL1JlbW92ZSB0aGUgdGV4dFxyXG4gICAgICAgIGlmKGlzRW50ZXJLZXkpe1xyXG4gICAgICAgICAgLy9jb25zb2xlLmxvZyhhbmNob3JOb2RlLnBhcmVudEVsZW1lbnQuaW5uZXJIVE1MKTtcclxuICAgICAgICAgIGFuY2hvck5vZGUucGFyZW50RWxlbWVudC5pbm5lclRleHQgPSBhbmNob3JOb2RlLnBhcmVudEVsZW1lbnQuaW5uZXJUZXh0LnJlcGxhY2UoJ0Bqb3MnLCcnKTtcclxuICAgICAgICAgIGFuY2hvck5vZGUucmVtb3ZlQ2hpbGQoYW5jaG9yTm9kZS5maXJzdENoaWxkKTsgLy8gLnByZXZpb3VzU2libGluZy5ub2RlVmFsdWUgPSBcIlwiO1xyXG4gICAgICAgICAgLy9hbmNob3JOb2RlLnByZXZpb3VzU2libGluZy50ZXh0Q29udGVudCA9IFwiXCI7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIGFuY2hvck5vZGUubm9kZVZhbHVlID0gXCJcIjtcclxuICAgICAgICAgIGFuY2hvck5vZGUudGV4dENvbnRlbnQgPSBcIlwiO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICBcclxuICAgICAgICAvL0NyZWF0ZSBzcGFucyBmb3IgdGhlIHByZWNlZWRpbmcgdGV4dCAmIGZvbGxvd2luZyB0ZXh0XHJcbiAgICAgICAgbGV0IGJlZm9yZUVsID0gZ2V0RG9jdW1lbnQoaWZyYW1lKS5jcmVhdGVFbGVtZW50KFwic3BhblwiKTtcclxuICAgICAgICBiZWZvcmVFbC5pbm5lclRleHQgPSBiZWZvcmVTdHJpbmc7XHJcbiAgICAgICAgbGV0IGFmdGVyRWwgPSBnZXREb2N1bWVudChpZnJhbWUpLmNyZWF0ZUVsZW1lbnQoXCJzcGFuXCIpO1xyXG4gICAgICAgIGFmdGVyRWwuaW5uZXJUZXh0ID0gYWZ0ZXJTdHJpbmc7XHJcbiAgICAgICAgXHJcbiAgICAgICAgLy9JbnNlcnQgdGhlIHNwYW5zICsgdGhlIG1lbnRpb24gZWxlbWVudFxyXG4gICAgICAgIC8vZGVidWdnZXI7XHJcbiAgICAgICAgYW5jaG9yTm9kZS5wYXJlbnROb2RlLmluc2VydEJlZm9yZShhZnRlckVsLCBhbmNob3JOb2RlLm5leHRTaWJsaW5nKTtcclxuICAgICAgICBhbmNob3JOb2RlLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHRleHQsIGFuY2hvck5vZGUubmV4dFNpYmxpbmcpO1xyXG4gICAgICAgIGFuY2hvck5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoYmVmb3JlRWwsIGFuY2hvck5vZGUubmV4dFNpYmxpbmcpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIC8vQ3JlYXRlIGEgcmFuZ2UgbG9jYXRlZCBhdGVyIHRoZSBtZW50aW9uXHJcbiAgICAgICAgbGV0IHJhbmdlID0gZ2V0RG9jdW1lbnQoaWZyYW1lKS5jcmVhdGVSYW5nZSgpO1xyXG4gICAgICAgIHJhbmdlLnNlbGVjdE5vZGUoYWZ0ZXJFbCk7XHJcbiAgICAgICAgcmFuZ2Uuc2V0U3RhcnQoYWZ0ZXJFbCwgMCk7XHJcbiAgICAgICAgcmFuZ2Uuc2V0RW5kKGFmdGVyRWwsIDApO1xyXG4gICAgICAgIFxyXG4gICAgICAgIC8vTW92ZSB0aGUgY3Vyc29yIHRvIHRoYXQgc3BvdFxyXG4gICAgICAgIHJhbmdlLmNvbGxhcHNlKGZhbHNlKTtcclxuICAgICAgICBzZWxPYmoucmVtb3ZlQWxsUmFuZ2VzKCk7XHJcbiAgICAgICAgc2VsT2JqLmFkZFJhbmdlKHJhbmdlKTtcclxuICAgICAgfVxyXG4gICAgICAvL3ZhciBodG1sTm9kZSA9IGJlZm9yZUVsLmlubmVySFRNTCArICB0ZXh0LmlubmVySFRNTCArIGFmdGVyRWwuaW5uZXJIVE1MO1xyXG4gICAgICAvL2FuY2hvck5vZGUucGFyZW50RWxlbWVudC5pbm5lckhUTUwgPSAgaHRtbE5vZGU7XHJcbiAgICAgIC8vYW5jaG9yTm9kZS5wYXJlbnROb2RlLmluc2VydEJlZm9yZSh0ZXh0LCBhbmNob3JOb2RlLm5leHRTaWJsaW5nKTtcclxuICAgICAgLy9hbmNob3JOb2RlLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKCkgLmluc2VydEJlZm9yZShiZWZvcmVFbCwgYW5jaG9yTm9kZS5uZXh0U2libGluZyk7XHJcbiAgICAgIC8vcmV0dXJuO1xyXG4gICAgICBcclxuICAgICAgXHJcbiAgICB9XHJcbiAgICBcclxuICAgIGV4cG9ydCBmdW5jdGlvbiBpc0lucHV0T3JUZXh0QXJlYUVsZW1lbnQoZWw6IEhUTUxFbGVtZW50KTogYm9vbGVhbiB7XHJcbiAgICAgIHJldHVybiBlbCAhPSBudWxsICYmIChlbC5ub2RlTmFtZSA9PSAnSU5QVVQnIHx8IGVsLm5vZGVOYW1lID09ICdURVhUQVJFQScpO1xyXG4gICAgfTtcclxuICAgIFxyXG4gICAgZXhwb3J0IGZ1bmN0aW9uIGlzVGV4dEVsZW1lbnQoZWw6IEhUTUxFbGVtZW50KTogYm9vbGVhbiB7XHJcbiAgICAgIHJldHVybiBlbCAhPSBudWxsICYmIChlbC5ub2RlTmFtZSA9PSAnSU5QVVQnIHx8IGVsLm5vZGVOYW1lID09ICdURVhUQVJFQScgfHwgZWwubm9kZU5hbWUgPT0gJyN0ZXh0Jyk7XHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICBleHBvcnQgZnVuY3Rpb24gc2V0Q2FyZXRQb3NpdGlvbihlbDogSFRNTElucHV0RWxlbWVudCwgcG9zOiBudW1iZXIsIGlmcmFtZTogSFRNTElGcmFtZUVsZW1lbnQgPSBudWxsKSB7XHJcbiAgICAgIC8vY29uc29sZS5sb2coXCJzZXRDYXJldFBvc2l0aW9uXCIsIHBvcywgZWwsIGlmcmFtZT09bnVsbCk7XHJcbiAgICAgIGlmIChpc0lucHV0T3JUZXh0QXJlYUVsZW1lbnQoZWwpICYmIGVsLnNlbGVjdGlvblN0YXJ0KSB7XHJcbiAgICAgICAgLy9lbC5mb2N1cygpO1xyXG4gICAgICAgIGVsLnNldFNlbGVjdGlvblJhbmdlKHBvcywgcG9zKTtcclxuICAgICAgfVxyXG4gICAgICBlbHNlIHtcclxuICAgICAgICBsZXQgcmFuZ2UgPSBnZXREb2N1bWVudChpZnJhbWUpLmNyZWF0ZVJhbmdlKCk7XHJcbiAgICAgICAgcmFuZ2Uuc2V0U3RhcnQoZWwsIHBvcyk7XHJcbiAgICAgICAgcmFuZ2UuY29sbGFwc2UodHJ1ZSk7XHJcbiAgICAgICAgbGV0IHNlbCA9IGdldFdpbmRvd1NlbGVjdGlvbihpZnJhbWUpO1xyXG4gICAgICAgIHNlbC5yZW1vdmVBbGxSYW5nZXMoKTtcclxuICAgICAgICBzZWwuYWRkUmFuZ2UocmFuZ2UpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGV4cG9ydCBmdW5jdGlvbiBnZXRDYXJldFBvc2l0aW9uKGVsOiBIVE1MSW5wdXRFbGVtZW50LCBpZnJhbWU6IEhUTUxJRnJhbWVFbGVtZW50ID0gbnVsbCkge1xyXG4gICAgICAvL2NvbnNvbGUubG9nKFwiZ2V0Q2FyZXRQb3NpdGlvblwiLCBlbCk7XHJcbiAgICAgIGlmIChpc0lucHV0T3JUZXh0QXJlYUVsZW1lbnQoZWwpKSB7XHJcbiAgICAgICAgdmFyIHZhbCA9IGVsLnZhbHVlO1xyXG4gICAgICAgIHJldHVybiB2YWwuc2xpY2UoMCwgZWwuc2VsZWN0aW9uU3RhcnQpLmxlbmd0aDtcclxuICAgICAgfVxyXG4gICAgICBlbHNlIHtcclxuICAgICAgICB2YXIgc2VsT2JqID0gZ2V0V2luZG93U2VsZWN0aW9uKGlmcmFtZSk7IC8vd2luZG93LmdldFNlbGVjdGlvbigpO1xyXG4gICAgICAgIGlmIChzZWxPYmoucmFuZ2VDb3VudCA+IDApIHtcclxuICAgICAgICAgIHZhciBzZWxSYW5nZSA9IHNlbE9iai5nZXRSYW5nZUF0KDApO1xyXG4gICAgICAgICAgdmFyIHByZUNhcmV0UmFuZ2UgPSBzZWxSYW5nZS5jbG9uZVJhbmdlKCk7XHJcbiAgICAgICAgICBwcmVDYXJldFJhbmdlLnNlbGVjdE5vZGVDb250ZW50cyhlbCk7XHJcbiAgICAgICAgICBwcmVDYXJldFJhbmdlLnNldEVuZChzZWxSYW5nZS5lbmRDb250YWluZXIsIHNlbFJhbmdlLmVuZE9mZnNldCk7XHJcbiAgICAgICAgICB2YXIgcG9zaXRpb24gPSBwcmVDYXJldFJhbmdlLnRvU3RyaW5nKCkubGVuZ3RoO1xyXG4gICAgICAgICAgcmV0dXJuIHBvc2l0aW9uO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgXHJcbiAgICAvLyBCYXNlZCBvbiBtZW50LmlvIGZ1bmN0aW9ucy4uLlxyXG4gICAgLy9cclxuICAgIFxyXG4gICAgZnVuY3Rpb24gZ2V0RG9jdW1lbnQoaWZyYW1lOiBIVE1MSUZyYW1lRWxlbWVudCkge1xyXG4gICAgICBpZiAoIWlmcmFtZSkge1xyXG4gICAgICAgIHJldHVybiBkb2N1bWVudDtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICByZXR1cm4gaWZyYW1lLmNvbnRlbnRXaW5kb3cuZG9jdW1lbnQ7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIFxyXG4gICAgZnVuY3Rpb24gZ2V0V2luZG93U2VsZWN0aW9uKGlmcmFtZTogSFRNTElGcmFtZUVsZW1lbnQpOiBTZWxlY3Rpb24ge1xyXG4gICAgICBpZiAoIWlmcmFtZSkge1xyXG4gICAgICAgIC8vY29uc29sZS5sb2cod2luZG93LmdldFNlbGVjdGlvbigpKTtcclxuICAgICAgICByZXR1cm4gd2luZG93LmdldFNlbGVjdGlvbigpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJldHVybiBpZnJhbWUuY29udGVudFdpbmRvdy5nZXRTZWxlY3Rpb24oKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgXHJcbiAgICBleHBvcnQgZnVuY3Rpb24gZ2V0Q29udGVudEVkaXRhYmxlQ2FyZXRDb29yZHMoY3R4OiB7IGlmcmFtZTogSFRNTElGcmFtZUVsZW1lbnQsIHBhcmVudD86IEVsZW1lbnQgfSkge1xyXG4gICAgICBsZXQgbWFya2VyVGV4dENoYXIgPSAnXFx1ZmVmZic7XHJcbiAgICAgIGxldCBtYXJrZXJJZCA9ICdzZWxfJyArIG5ldyBEYXRlKCkuZ2V0VGltZSgpICsgJ18nICsgTWF0aC5yYW5kb20oKS50b1N0cmluZygpLnN1YnN0cigyKTtcclxuICAgICAgbGV0IGRvYyA9IGdldERvY3VtZW50KGN0eCA/IGN0eC5pZnJhbWUgOiBudWxsKTtcclxuICAgICAgbGV0IHNlbCA9IGdldFdpbmRvd1NlbGVjdGlvbihjdHggPyBjdHguaWZyYW1lIDogbnVsbCk7XHJcbiAgICAgIGxldCBwcmV2UmFuZ2UgPSBzZWwuZ2V0UmFuZ2VBdCgwKTtcclxuICAgICAgXHJcbiAgICAgIC8vIGNyZWF0ZSBuZXcgcmFuZ2UgYW5kIHNldCBwb3N0aW9uIHVzaW5nIHByZXZSYW5nZVxyXG4gICAgICBsZXQgcmFuZ2UgPSBkb2MuY3JlYXRlUmFuZ2UoKTtcclxuICAgICAgcmFuZ2Uuc2V0U3RhcnQoc2VsLmFuY2hvck5vZGUsIHByZXZSYW5nZS5zdGFydE9mZnNldCk7XHJcbiAgICAgIHJhbmdlLnNldEVuZChzZWwuYW5jaG9yTm9kZSwgcHJldlJhbmdlLnN0YXJ0T2Zmc2V0KTtcclxuICAgICAgcmFuZ2UuY29sbGFwc2UoZmFsc2UpO1xyXG4gICAgICBcclxuICAgICAgLy8gQ3JlYXRlIHRoZSBtYXJrZXIgZWxlbWVudCBjb250YWluaW5nIGEgc2luZ2xlIGludmlzaWJsZSBjaGFyYWN0ZXJcclxuICAgICAgLy8gdXNpbmcgRE9NIG1ldGhvZHMgYW5kIGluc2VydCBpdCBhdCB0aGUgcG9zaXRpb24gaW4gdGhlIHJhbmdlXHJcbiAgICAgIGxldCBtYXJrZXJFbCA9IGRvYy5jcmVhdGVFbGVtZW50KCdzcGFuJyk7XHJcbiAgICAgIG1hcmtlckVsLmlkID0gbWFya2VySWQ7XHJcbiAgICAgIG1hcmtlckVsLmFwcGVuZENoaWxkKGRvYy5jcmVhdGVUZXh0Tm9kZShtYXJrZXJUZXh0Q2hhcikpO1xyXG4gICAgICByYW5nZS5pbnNlcnROb2RlKG1hcmtlckVsKTtcclxuICAgICAgc2VsLnJlbW92ZUFsbFJhbmdlcygpO1xyXG4gICAgICBzZWwuYWRkUmFuZ2UocHJldlJhbmdlKTtcclxuICAgICAgXHJcbiAgICAgIGxldCBjb29yZGluYXRlcyA9IHtcclxuICAgICAgICBsZWZ0OiAwLFxyXG4gICAgICAgIHRvcDogbWFya2VyRWwub2Zmc2V0SGVpZ2h0XHJcbiAgICAgIH07XHJcbiAgICAgIFxyXG4gICAgICBsb2NhbFRvUmVsYXRpdmVDb29yZGluYXRlcyhjdHgsIG1hcmtlckVsLCBjb29yZGluYXRlcyk7XHJcbiAgICAgIFxyXG4gICAgICBtYXJrZXJFbC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKG1hcmtlckVsKTtcclxuICAgICAgcmV0dXJuIGNvb3JkaW5hdGVzO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBmdW5jdGlvbiBsb2NhbFRvUmVsYXRpdmVDb29yZGluYXRlcyhcclxuICAgICAgY3R4OiB7IGlmcmFtZTogSFRNTElGcmFtZUVsZW1lbnQsIHBhcmVudD86IEVsZW1lbnQgfSxcclxuICAgICAgZWxlbWVudDogRWxlbWVudCxcclxuICAgICAgY29vcmRpbmF0ZXM6IHsgdG9wOiBudW1iZXI7IGxlZnQ6IG51bWJlciB9XHJcbiAgICAgICkge1xyXG4gICAgICAgIGxldCBvYmogPSA8SFRNTEVsZW1lbnQ+ZWxlbWVudDtcclxuICAgICAgICBsZXQgaWZyYW1lID0gY3R4ID8gY3R4LmlmcmFtZSA6IG51bGw7XHJcbiAgICAgICAgd2hpbGUgKG9iaikge1xyXG4gICAgICAgICAgaWYgKGN0eC5wYXJlbnQgIT0gbnVsbCAmJiBjdHgucGFyZW50ID09IG9iaikge1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGNvb3JkaW5hdGVzLmxlZnQgKz0gb2JqLm9mZnNldExlZnQgKyBvYmouY2xpZW50TGVmdDtcclxuICAgICAgICAgIGNvb3JkaW5hdGVzLnRvcCArPSBvYmoub2Zmc2V0VG9wICsgb2JqLmNsaWVudFRvcDtcclxuICAgICAgICAgIG9iaiA9IDxIVE1MRWxlbWVudD5vYmoub2Zmc2V0UGFyZW50O1xyXG4gICAgICAgICAgaWYgKCFvYmogJiYgaWZyYW1lKSB7XHJcbiAgICAgICAgICAgIG9iaiA9IGlmcmFtZTtcclxuICAgICAgICAgICAgaWZyYW1lID0gbnVsbDtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgb2JqID0gPEhUTUxFbGVtZW50PmVsZW1lbnQ7XHJcbiAgICAgICAgaWZyYW1lID0gY3R4ID8gY3R4LmlmcmFtZSA6IG51bGw7XHJcbiAgICAgICAgd2hpbGUgKG9iaiAhPT0gZ2V0RG9jdW1lbnQobnVsbCkuYm9keSAmJiBvYmogIT0gbnVsbCkge1xyXG4gICAgICAgICAgaWYgKGN0eC5wYXJlbnQgIT0gbnVsbCAmJiBjdHgucGFyZW50ID09IG9iaikge1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGlmIChvYmouc2Nyb2xsVG9wICYmIG9iai5zY3JvbGxUb3AgPiAwKSB7XHJcbiAgICAgICAgICAgIGNvb3JkaW5hdGVzLnRvcCAtPSBvYmouc2Nyb2xsVG9wO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgaWYgKG9iai5zY3JvbGxMZWZ0ICYmIG9iai5zY3JvbGxMZWZ0ID4gMCkge1xyXG4gICAgICAgICAgICBjb29yZGluYXRlcy5sZWZ0IC09IG9iai5zY3JvbGxMZWZ0O1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgb2JqID0gPEhUTUxFbGVtZW50Pm9iai5wYXJlbnROb2RlO1xyXG4gICAgICAgICAgaWYgKCFvYmogJiYgaWZyYW1lKSB7XHJcbiAgICAgICAgICAgIG9iaiA9IGlmcmFtZTtcclxuICAgICAgICAgICAgaWZyYW1lID0gbnVsbDtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgIl19