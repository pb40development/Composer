// DOM element manipulation functions...
//
function setValue(el, value) {
    if (isInputOrTextAreaElement(el)) {
        el.value = value;
    }
    else {
        el.textContent = value;
    }
}
export function getValue(el) {
    return isInputOrTextAreaElement(el) ? el.value : el.textContent;
}
export function insertValue(el, start, end, insertHTML, text, iframe, noRecursion) {
    if (noRecursion === void 0) { noRecursion = false; }
    if (isTextElement(el)) {
        var val = getValue(el);
        setValue(el, val.substring(0, start) + text + val.substring(end, val.length));
        setCaretPosition(el, start + text.length, iframe);
    }
    else if (!noRecursion) {
        var selObj = getWindowSelection(iframe);
        //console.log(selObj);
        if (selObj && selObj.rangeCount > 0) {
            // var selRange = selObj.getRangeAt(0);
            // var position = selRange.startOffset;
            // var anchorNode = selObj.anchorNode;
            // if (text.endsWith(' ')) {
            //   text = text.substring(0, text.length-1) + '\xA0';
            // }
            // insertValue(<HTMLInputElement>anchorNode, position - (end - start), position, text, iframe, true);
            if (insertHTML) {
                insertElement(selObj, start, end, text, iframe);
            }
            else {
                var selRange = selObj.getRangeAt(0);
                var position = selRange.startOffset;
                var anchorNode = selObj.anchorNode;
                // if (text.endsWith(' ')) {
                //   text = text.substring(0, text.length-1) + '\xA0';
                // }
                insertValue(anchorNode, position - (end - start), position, insertHTML, text, iframe, true);
            }
        }
    }
}
function makeAngularElements(el) {
    if (!(el instanceof HTMLElement)) {
        return;
    }
    el.setAttribute("_ngcontent-c0", '');
    for (var i in el.children) {
        makeAngularElements(el.children[i]);
    }
}
function insertElement(selObj, start, end, text, iframe) {
    //console.log(start, end);
    if (!(text instanceof HTMLElement)) {
        var e = getDocument(iframe).createElement("span");
        e.innerHTML = text;
        text = e;
    }
    //make the element an angular element
    makeAngularElements(text);
    var anchorNode = selObj.anchorNode;
    //var anchorNode = selObj.anchorNode.previousSibling;
    //debugger;
    //console.log(selObj);
    //console.log(anchorNode);
    //console.log(anchorNode.nodeValue);
    //Get the text that preceeded and followed what was typed as part of the autocomplete
    var beforeString = '';
    var afterString = '';
    var isEnterKey = false;
    if (anchorNode.hasChildNodes() && anchorNode.firstChild.parentElement.innerHTML == '<br>') {
        isEnterKey = true;
        var contentHTML = anchorNode.parentElement.innerHTML;
        //var qtyLineBreaks = contentHTML.substring(0, ) .split('')
        var contentToReplace = anchorNode.parentElement.innerText.substring(start, end);
        contentToReplace = contentToReplace.replace('\n', '');
        if (contentToReplace.indexOf('@') == -1) {
            contentToReplace = '@' + contentToReplace;
        }
        if (text.innerHTML.indexOf('@') == -1) {
            text.innerHTML = '&#64;' + text.innerHTML;
        }
        contentHTML = contentHTML.replace(contentToReplace, text.innerHTML);
        anchorNode.parentElement.innerHTML = contentHTML;
    }
    else {
        if (anchorNode.nodeValue) {
            //console.log(anchorNode);
            beforeString = anchorNode.nodeValue.substr(0, start);
            afterString = anchorNode.nodeValue.substring(end);
        }
        else if (anchorNode.textContent) {
            beforeString = anchorNode.textContent.substr(0, start);
            afterString = anchorNode.textContent.substring(end);
        }
        else {
            beforeString = '';
            afterString = text.innerText.substring(end);
        }
        //console.log("beforeString:",beforeString);
        //console.log("afterString:",afterString);
        //removing previous typed search string
        var positionChar = beforeString.lastIndexOf('@');
        //console.log(" positionChar:", positionChar);
        if (positionChar < 0) {
            beforeString = beforeString + '@';
            var positionChar = beforeString.lastIndexOf('@');
            //console.log(" beforeString 2:", beforeString);
        }
        beforeString = beforeString.substring(0, positionChar + 1);
        //console.log("beforeString final:",beforeString);
        //Remove the text
        if (isEnterKey) {
            //console.log(anchorNode.parentElement.innerHTML);
            anchorNode.parentElement.innerText = anchorNode.parentElement.innerText.replace('@jos', '');
            anchorNode.removeChild(anchorNode.firstChild); // .previousSibling.nodeValue = "";
            //anchorNode.previousSibling.textContent = "";
        }
        else {
            anchorNode.nodeValue = "";
            anchorNode.textContent = "";
        }
        //Create spans for the preceeding text & following text
        var beforeEl = getDocument(iframe).createElement("span");
        beforeEl.innerText = beforeString;
        var afterEl = getDocument(iframe).createElement("span");
        afterEl.innerText = afterString;
        //Insert the spans + the mention element
        //debugger;
        anchorNode.parentNode.insertBefore(afterEl, anchorNode.nextSibling);
        anchorNode.parentNode.insertBefore(text, anchorNode.nextSibling);
        anchorNode.parentNode.insertBefore(beforeEl, anchorNode.nextSibling);
        //Create a range located ater the mention
        var range = getDocument(iframe).createRange();
        range.selectNode(afterEl);
        range.setStart(afterEl, 0);
        range.setEnd(afterEl, 0);
        //Move the cursor to that spot
        range.collapse(false);
        selObj.removeAllRanges();
        selObj.addRange(range);
    }
    //var htmlNode = beforeEl.innerHTML +  text.innerHTML + afterEl.innerHTML;
    //anchorNode.parentElement.innerHTML =  htmlNode;
    //anchorNode.parentNode.insertBefore(text, anchorNode.nextSibling);
    //anchorNode.parentNode.insertBefore() .insertBefore(beforeEl, anchorNode.nextSibling);
    //return;
}
export function isInputOrTextAreaElement(el) {
    return el != null && (el.nodeName == 'INPUT' || el.nodeName == 'TEXTAREA');
}
;
export function isTextElement(el) {
    return el != null && (el.nodeName == 'INPUT' || el.nodeName == 'TEXTAREA' || el.nodeName == '#text');
}
;
export function setCaretPosition(el, pos, iframe) {
    if (iframe === void 0) { iframe = null; }
    //console.log("setCaretPosition", pos, el, iframe==null);
    if (isInputOrTextAreaElement(el) && el.selectionStart) {
        //el.focus();
        el.setSelectionRange(pos, pos);
    }
    else {
        var range = getDocument(iframe).createRange();
        range.setStart(el, pos);
        range.collapse(true);
        var sel = getWindowSelection(iframe);
        sel.removeAllRanges();
        sel.addRange(range);
    }
}
export function getCaretPosition(el, iframe) {
    if (iframe === void 0) { iframe = null; }
    //console.log("getCaretPosition", el);
    if (isInputOrTextAreaElement(el)) {
        var val = el.value;
        return val.slice(0, el.selectionStart).length;
    }
    else {
        var selObj = getWindowSelection(iframe); //window.getSelection();
        if (selObj.rangeCount > 0) {
            var selRange = selObj.getRangeAt(0);
            var preCaretRange = selRange.cloneRange();
            preCaretRange.selectNodeContents(el);
            preCaretRange.setEnd(selRange.endContainer, selRange.endOffset);
            var position = preCaretRange.toString().length;
            return position;
        }
    }
}
// Based on ment.io functions...
//
function getDocument(iframe) {
    if (!iframe) {
        return document;
    }
    else {
        return iframe.contentWindow.document;
    }
}
function getWindowSelection(iframe) {
    if (!iframe) {
        //console.log(window.getSelection());
        return window.getSelection();
    }
    else {
        return iframe.contentWindow.getSelection();
    }
}
export function getContentEditableCaretCoords(ctx) {
    var markerTextChar = '\ufeff';
    var markerId = 'sel_' + new Date().getTime() + '_' + Math.random().toString().substr(2);
    var doc = getDocument(ctx ? ctx.iframe : null);
    var sel = getWindowSelection(ctx ? ctx.iframe : null);
    var prevRange = sel.getRangeAt(0);
    // create new range and set postion using prevRange
    var range = doc.createRange();
    range.setStart(sel.anchorNode, prevRange.startOffset);
    range.setEnd(sel.anchorNode, prevRange.startOffset);
    range.collapse(false);
    // Create the marker element containing a single invisible character
    // using DOM methods and insert it at the position in the range
    var markerEl = doc.createElement('span');
    markerEl.id = markerId;
    markerEl.appendChild(doc.createTextNode(markerTextChar));
    range.insertNode(markerEl);
    sel.removeAllRanges();
    sel.addRange(prevRange);
    var coordinates = {
        left: 0,
        top: markerEl.offsetHeight
    };
    localToRelativeCoordinates(ctx, markerEl, coordinates);
    markerEl.parentNode.removeChild(markerEl);
    return coordinates;
}
function localToRelativeCoordinates(ctx, element, coordinates) {
    var obj = element;
    var iframe = ctx ? ctx.iframe : null;
    while (obj) {
        if (ctx.parent != null && ctx.parent == obj) {
            break;
        }
        coordinates.left += obj.offsetLeft + obj.clientLeft;
        coordinates.top += obj.offsetTop + obj.clientTop;
        obj = obj.offsetParent;
        if (!obj && iframe) {
            obj = iframe;
            iframe = null;
        }
    }
    obj = element;
    iframe = ctx ? ctx.iframe : null;
    while (obj !== getDocument(null).body && obj != null) {
        if (ctx.parent != null && ctx.parent == obj) {
            break;
        }
        if (obj.scrollTop && obj.scrollTop > 0) {
            coordinates.top -= obj.scrollTop;
        }
        if (obj.scrollLeft && obj.scrollLeft > 0) {
            coordinates.left -= obj.scrollLeft;
        }
        obj = obj.parentNode;
        if (!obj && iframe) {
            obj = iframe;
            iframe = null;
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVudGlvbi11dGlscy5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2tsLWFuZ3VsYXItbWVudGlvbnMvIiwic291cmNlcyI6WyJsaWIvbWVudGlvbi11dGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSx3Q0FBd0M7QUFDeEMsRUFBRTtBQUVGLFNBQVMsUUFBUSxDQUFDLEVBQW9CLEVBQUUsS0FBVTtJQUNoRCxJQUFJLHdCQUF3QixDQUFDLEVBQUUsQ0FBQyxFQUFFO1FBQ2hDLEVBQUUsQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO0tBQ2xCO1NBQ0k7UUFDSCxFQUFFLENBQUMsV0FBVyxHQUFHLEtBQUssQ0FBQztLQUN4QjtBQUNILENBQUM7QUFFRCxNQUFNLFVBQVUsUUFBUSxDQUFDLEVBQW9CO0lBQzNDLE9BQU8sd0JBQXdCLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxXQUFXLENBQUM7QUFDbEUsQ0FBQztBQUVELE1BQU0sVUFBVSxXQUFXLENBQ3pCLEVBQW9CLEVBQ3BCLEtBQWEsRUFDYixHQUFXLEVBQ1gsVUFBbUIsRUFDbkIsSUFBUyxFQUNULE1BQXlCLEVBQ3pCLFdBQTRCO0lBQTVCLDRCQUFBLEVBQUEsbUJBQTRCO0lBRzFCLElBQUksYUFBYSxDQUFDLEVBQUUsQ0FBQyxFQUFFO1FBQ3JCLElBQUksR0FBRyxHQUFHLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUN2QixRQUFRLENBQUMsRUFBRSxFQUFFLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxHQUFHLElBQUksR0FBRyxHQUFHLENBQUMsU0FBUyxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztRQUM5RSxnQkFBZ0IsQ0FBQyxFQUFFLEVBQUUsS0FBSyxHQUFHLElBQUksQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUM7S0FDbkQ7U0FD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SUFBSSxHQUFHLENBQUMsVUFBVSxHQUFHLENBQUMsRUFBRTtZQUN4QyxXQUFXLENBQUMsSUFBSSxJQUFJLEdBQUcsQ0FBQyxVQUFVLENBQUM7U0FDcEM7UUFDRCxHQUFHLEdBQWdCLEdBQUcsQ0FBQyxVQUFVLENBQUM7UUFDbEMsSUFBSSxDQUFDLEdBQUcsSUFBSSxNQUFNLEVBQUU7WUFDbEIsR0FBRyxHQUFHLE1BQU0sQ0FBQztZQUNiLE1BQU0sR0FBRyxJQUFJLENBQUM7U0FDZjtLQUNGO0FBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIERPTSBlbGVtZW50IG1hbmlwdWxhdGlvbiBmdW5jdGlvbnMuLi5cclxuLy9cclxuXHJcbmZ1bmN0aW9uIHNldFZhbHVlKGVsOiBIVE1MSW5wdXRFbGVtZW50LCB2YWx1ZTogYW55KSB7XHJcbiAgaWYgKGlzSW5wdXRPclRleHRBcmVhRWxlbWVudChlbCkpIHtcclxuICAgIGVsLnZhbHVlID0gdmFsdWU7XHJcbiAgfVxyXG4gIGVsc2Uge1xyXG4gICAgZWwudGV4dENvbnRlbnQgPSB2YWx1ZTtcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRWYWx1ZShlbDogSFRNTElucHV0RWxlbWVudCkge1xyXG4gIHJldHVybiBpc0lucHV0T3JUZXh0QXJlYUVsZW1lbnQoZWwpID8gZWwudmFsdWUgOiBlbC50ZXh0Q29udGVudDtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGluc2VydFZhbHVlKFxyXG4gIGVsOiBIVE1MSW5wdXRFbGVtZW50LFxyXG4gIHN0YXJ0OiBudW1iZXIsXHJcbiAgZW5kOiBudW1iZXIsXHJcbiAgaW5zZXJ0SFRNTDogYm9vbGVhbixcclxuICB0ZXh0OiBhbnksXHJcbiAgaWZyYW1lOiBIVE1MSUZyYW1lRWxlbWVudCxcclxuICBub1JlY3Vyc2lvbjogYm9vbGVhbiA9IGZhbHNlXHJcbiAgKSB7XHJcbiAgICBcclxuICAgIGlmIChpc1RleHRFbGVtZW50KGVsKSkge1xyXG4gICAgICBsZXQgdmFsID0gZ2V0VmFsdWUoZWwpO1xyXG4gICAgICBzZXRWYWx1ZShlbCwgdmFsLnN1YnN0cmluZygwLCBzdGFydCkgKyB0ZXh0ICsgdmFsLnN1YnN0cmluZyhlbmQsIHZhbC5sZW5ndGgpKTtcclxuICAgICAgc2V0Q2FyZXRQb3NpdGlvbihlbCwgc3RhcnQgKyB0ZXh0Lmxlbmd0aCwgaWZyYW1lKTtcclxuICAgIH1cclxuICAgIGVsc2UgaWYgKCFub1JlY3Vyc2lvbikge1xyXG4gICAgICBsZXQgc2VsT2JqOiBTZWxlY3Rpb24gPSBnZXRXaW5kb3dTZWxlY3Rpb24oaWZyYW1lKTtcclxuICAgICAgLy9jb25zb2xlLmxvZyhzZWxPYmopO1xyXG4gICAgICBpZiAoc2VsT2JqICYmIHNlbE9iai5yYW5nZUNvdW50ID4gMCkge1xyXG4gICAgICAgIC8vIHZhciBzZWxSYW5nZSA9IHNlbE9iai5nZXRSYW5nZUF0KDApO1xyXG4gICAgICAgIC8vIHZhciBwb3NpdGlvbiA9IHNlbFJhbmdlLnN0YXJ0T2Zmc2V0O1xyXG4gICAgICAgIC8vIHZhciBhbmNob3JOb2RlID0gc2VsT2JqLmFuY2hvck5vZGU7XHJcbiAgICAgICAgLy8gaWYgKHRleHQuZW5kc1dpdGgoJyAnKSkge1xyXG4gICAgICAgIC8vICAgdGV4dCA9IHRleHQuc3Vic3RyaW5nKDAsIHRleHQubGVuZ3RoLTEpICsgJ1xceEEwJztcclxuICAgICAgICAvLyB9XHJcbiAgICAgICAgLy8gaW5zZXJ0VmFsdWUoPEhUTUxJbnB1dEVsZW1lbnQ+YW5jaG9yTm9kZSwgcG9zaXRpb24gLSAoZW5kIC0gc3RhcnQpLCBwb3NpdGlvbiwgdGV4dCwgaWZyYW1lLCB0cnVlKTtcclxuICAgICAgICBcclxuICAgICAgICBpZiAoaW5zZXJ0SFRNTCkge1xyXG4gICAgICAgICAgaW5zZXJ0RWxlbWVudChzZWxPYmosIHN0YXJ0LCBlbmQsIHRleHQsIGlmcmFtZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgdmFyIHNlbFJhbmdlID0gc2VsT2JqLmdldFJhbmdlQXQoMCk7XHJcbiAgICAgICAgICB2YXIgcG9zaXRpb24gPSBzZWxSYW5nZS5zdGFydE9mZnNldDtcclxuICAgICAgICAgIHZhciBhbmNob3JOb2RlID0gc2VsT2JqLmFuY2hvck5vZGU7XHJcbiAgICAgICAgICAvLyBpZiAodGV4dC5lbmRzV2l0aCgnICcpKSB7XHJcbiAgICAgICAgICAvLyAgIHRleHQgPSB0ZXh0LnN1YnN0cmluZygwLCB0ZXh0Lmxlbmd0aC0xKSArICdcXHhBMCc7XHJcbiAgICAgICAgICAvLyB9XHJcbiAgICAgICAgICBcclxuICAgICAgICAgIGluc2VydFZhbHVlKDxIVE1MSW5wdXRFbGVtZW50PmFuY2hvck5vZGUsIHBvc2l0aW9uIC0gKGVuZCAtIHN0YXJ0KSwgcG9zaXRpb24sIGluc2VydEhUTUwsIHRleHQsIGlmcmFtZSwgdHJ1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG4gIFxyXG4gIGZ1bmN0aW9uIG1ha2VBbmd1bGFyRWxlbWVudHMoZWwpIHtcclxuICAgIGlmICghKGVsIGluc3RhbmNlb2YgSFRNTEVsZW1lbnQpKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGVsLnNldEF0dHJpYnV0ZShcIl9uZ2NvbnRlbnQtYzBcIiwgJycpO1xyXG4gICAgZm9yIChsZXQgaSBpbiBlbC5jaGlsZHJlbikge1xyXG4gICAgICBtYWtlQW5ndWxhckVsZW1lbnRzKGVsLmNoaWxkcmVuW2ldKVxyXG4gICAgfVxyXG4gIH1cclxuICBcclxuICBcclxuICBmdW5jdGlvbiBpbnNlcnRFbGVtZW50KFxyXG4gICAgc2VsT2JqOiBTZWxlY3Rpb24sXHJcbiAgICBzdGFydDogbnVtYmVyLFxyXG4gICAgZW5kOiBudW1iZXIsXHJcbiAgICB0ZXh0OiBIVE1MRWxlbWVudCxcclxuICAgIGlmcmFtZTogSFRNTElGcmFtZUVsZW1lbnRcclxuICAgICkge1xyXG4gICAgICBcclxuICAgICAgLy9jb25zb2xlLmxvZyhzdGFydCwgZW5kKTtcclxuICAgICAgXHJcbiAgICAgIGlmICghKHRleHQgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkpIHtcclxuICAgICAgICB2YXIgZSA9IGdldERvY3VtZW50KGlmcmFtZSkuY3JlYXRlRWxlbWVudChcInNwYW5cIik7XHJcbiAgICAgICAgZS5pbm5lckhUTUwgPSB0ZXh0O1xyXG4gICAgICAgIHRleHQgPSBlO1xyXG4gICAgICB9XHJcbiAgICAgIFxyXG4gICAgICAvL21ha2UgdGhlIGVsZW1lbnQgYW4gYW5ndWxhciBlbGVtZW50XHJcbiAgICAgIG1ha2VBbmd1bGFyRWxlbWVudHModGV4dCk7XHJcbiAgICAgIFxyXG4gICAgICBcclxuICAgICAgdmFyIGFuY2hvck5vZGUgPSBzZWxPYmouYW5jaG9yTm9kZTtcclxuICAgICAgLy92YXIgYW5jaG9yTm9kZSA9IHNlbE9iai5hbmNob3JOb2RlLnByZXZpb3VzU2libGluZztcclxuICAgICAgLy9kZWJ1Z2dlcjtcclxuICAgICAgXHJcbiAgICAgIC8vY29uc29sZS5sb2coc2VsT2JqKTtcclxuICAgICAgLy9jb25zb2xlLmxvZyhhbmNob3JOb2RlKTtcclxuICAgICAgLy9jb25zb2xlLmxvZyhhbmNob3JOb2RlLm5vZGVWYWx1ZSk7XHJcbiAgICAgIC8vR2V0IHRoZSB0ZXh0IHRoYXQgcHJlY2VlZGVkIGFuZCBmb2xsb3dlZCB3aGF0IHdhcyB0eXBlZCBhcyBwYXJ0IG9mIHRoZSBhdXRvY29tcGxldGVcclxuICAgICAgdmFyIGJlZm9yZVN0cmluZyA9ICcnO1xyXG4gICAgICB2YXIgYWZ0ZXJTdHJpbmcgPSAnJztcclxuICAgICAgdmFyIGlzRW50ZXJLZXkgPSBmYWxzZTtcclxuICAgICAgXHJcbiAgICAgIGlmKGFuY2hvck5vZGUuaGFzQ2hpbGROb2RlcygpICYmIGFuY2hvck5vZGUuZmlyc3RDaGlsZC5wYXJlbnRFbGVtZW50LmlubmVySFRNTCA9PSAnPGJyPicpICB7XHJcbiAgICAgICAgaXNFbnRlcktleSA9IHRydWU7XHJcbiAgICAgICAgXHJcbiAgICAgICAgdmFyIGNvbnRlbnRIVE1MID0gYW5jaG9yTm9kZS5wYXJlbnRFbGVtZW50LmlubmVySFRNTDtcclxuICAgICAgICAvL3ZhciBxdHlMaW5lQnJlYWtzID0gY29udGVudEhUTUwuc3Vic3RyaW5nKDAsICkgLnNwbGl0KCcnKVxyXG4gICAgICAgIHZhciBjb250ZW50VG9SZXBsYWNlID0gYW5jaG9yTm9kZS5wYXJlbnRFbGVtZW50LmlubmVyVGV4dC5zdWJzdHJpbmcoc3RhcnQsIGVuZCk7XHJcbiAgICAgICAgY29udGVudFRvUmVwbGFjZSA9ICBjb250ZW50VG9SZXBsYWNlLnJlcGxhY2UoJ1xcbicsJycpO1xyXG5cclxuICAgICAgICBpZihjb250ZW50VG9SZXBsYWNlLmluZGV4T2YoJ0AnKSA9PSAtMSl7XHJcbiAgICAgICAgICBjb250ZW50VG9SZXBsYWNlID0gJ0AnICsgY29udGVudFRvUmVwbGFjZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYodGV4dC5pbm5lckhUTUwuaW5kZXhPZignQCcpID09IC0xICl7XHJcbiAgICAgICAgICB0ZXh0LmlubmVySFRNTCA9ICcmIzY0OycgKyB0ZXh0LmlubmVySFRNTDtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29udGVudEhUTUwgPSBjb250ZW50SFRNTC5yZXBsYWNlKGNvbnRlbnRUb1JlcGxhY2UsIHRleHQuaW5uZXJIVE1MKTtcclxuXHJcbiAgICAgICAgYW5jaG9yTm9kZS5wYXJlbnRFbGVtZW50LmlubmVySFRNTCA9IGNvbnRlbnRIVE1MO1xyXG4gICAgICAgIFxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIFxyXG4gICAgICAgICBpZihhbmNob3JOb2RlLm5vZGVWYWx1ZSl7XHJcbiAgICAgICAgICAvL2NvbnNvbGUubG9nKGFuY2hvck5vZGUpO1xyXG4gICAgICAgICAgYmVmb3JlU3RyaW5nID0gYW5jaG9yTm9kZS5ub2RlVmFsdWUuc3Vic3RyKDAsIHN0YXJ0KTtcclxuICAgICAgICAgIGFmdGVyU3RyaW5nID0gYW5jaG9yTm9kZS5ub2RlVmFsdWUuc3Vic3RyaW5nKGVuZCk7ICBcclxuICAgICAgICB9IGVsc2UgaWYoYW5jaG9yTm9kZS50ZXh0Q29udGVudCl7XHJcbiAgICAgICAgICBiZWZvcmVTdHJpbmcgPSBhbmNob3JOb2RlLnRleHRDb250ZW50LnN1YnN0cigwLCBzdGFydCk7XHJcbiAgICAgICAgICBhZnRlclN0cmluZyA9IGFuY2hvck5vZGUudGV4dENvbnRlbnQuc3Vic3RyaW5nKGVuZCk7ICBcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgYmVmb3JlU3RyaW5nID0gJyc7XHJcbiAgICAgICAgICBhZnRlclN0cmluZyA9IHRleHQuaW5uZXJUZXh0LnN1YnN0cmluZyhlbmQpOyAgXHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIC8vY29uc29sZS5sb2coXCJiZWZvcmVTdHJpbmc6XCIsYmVmb3JlU3RyaW5nKTtcclxuICAgICAgICAvL2NvbnNvbGUubG9nKFwiYWZ0ZXJTdHJpbmc6XCIsYWZ0ZXJTdHJpbmcpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIC8vcmVtb3ZpbmcgcHJldmlvdXMgdHlwZWQgc2VhcmNoIHN0cmluZ1xyXG4gICAgICAgIHZhciBwb3NpdGlvbkNoYXIgPSBiZWZvcmVTdHJpbmcubGFzdEluZGV4T2YoJ0AnKTtcclxuICAgICAgICBcclxuICAgICAgICAvL2NvbnNvbGUubG9nKFwiIHBvc2l0aW9uQ2hhcjpcIiwgcG9zaXRpb25DaGFyKTtcclxuICAgICAgICBcclxuICAgICAgICBpZihwb3NpdGlvbkNoYXIgPCAwKSB7XHJcbiAgICAgICAgICBiZWZvcmVTdHJpbmcgPSBiZWZvcmVTdHJpbmcgKyAnQCc7XHJcbiAgICAgICAgICB2YXIgcG9zaXRpb25DaGFyID0gYmVmb3JlU3RyaW5nLmxhc3RJbmRleE9mKCdAJyk7XHJcbiAgICAgICAgICAvL2NvbnNvbGUubG9nKFwiIGJlZm9yZVN0cmluZyAyOlwiLCBiZWZvcmVTdHJpbmcpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICBcclxuICAgICAgICBiZWZvcmVTdHJpbmcgPSBiZWZvcmVTdHJpbmcuc3Vic3RyaW5nKDAsICBwb3NpdGlvbkNoYXIgKyAxKTtcclxuICAgICAgICAvL2NvbnNvbGUubG9nKFwiYmVmb3JlU3RyaW5nIGZpbmFsOlwiLGJlZm9yZVN0cmluZyk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgLy9SZW1vdmUgdGhlIHRleHRcclxuICAgICAgICBpZihpc0VudGVyS2V5KXtcclxuICAgICAgICAgIC8vY29uc29sZS5sb2coYW5jaG9yTm9kZS5wYXJlbnRFbGVtZW50LmlubmVySFRNTCk7XHJcbiAgICAgICAgICBhbmNob3JOb2RlLnBhcmVudEVsZW1lbnQuaW5uZXJUZXh0ID0gYW5jaG9yTm9kZS5wYXJlbnRFbGVtZW50LmlubmVyVGV4dC5yZXBsYWNlKCdAam9zJywnJyk7XHJcbiAgICAgICAgICBhbmNob3JOb2RlLnJlbW92ZUNoaWxkKGFuY2hvck5vZGUuZmlyc3RDaGlsZCk7IC8vIC5wcmV2aW91c1NpYmxpbmcubm9kZVZhbHVlID0gXCJcIjtcclxuICAgICAgICAgIC8vYW5jaG9yTm9kZS5wcmV2aW91c1NpYmxpbmcudGV4dENvbnRlbnQgPSBcIlwiO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBhbmNob3JOb2RlLm5vZGVWYWx1ZSA9IFwiXCI7XHJcbiAgICAgICAgICBhbmNob3JOb2RlLnRleHRDb250ZW50ID0gXCJcIjtcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgXHJcbiAgICAgICAgLy9DcmVhdGUgc3BhbnMgZm9yIHRoZSBwcmVjZWVkaW5nIHRleHQgJiBmb2xsb3dpbmcgdGV4dFxyXG4gICAgICAgIGxldCBiZWZvcmVFbCA9IGdldERvY3VtZW50KGlmcmFtZSkuY3JlYXRlRWxlbWVudChcInNwYW5cIik7XHJcbiAgICAgICAgYmVmb3JlRWwuaW5uZXJUZXh0ID0gYmVmb3JlU3RyaW5nO1xyXG4gICAgICAgIGxldCBhZnRlckVsID0gZ2V0RG9jdW1lbnQoaWZyYW1lKS5jcmVhdGVFbGVtZW50KFwic3BhblwiKTtcclxuICAgICAgICBhZnRlckVsLmlubmVyVGV4dCA9IGFmdGVyU3RyaW5nO1xyXG4gICAgICAgIFxyXG4gICAgICAgIC8vSW5zZXJ0IHRoZSBzcGFucyArIHRoZSBtZW50aW9uIGVsZW1lbnRcclxuICAgICAgICAvL2RlYnVnZ2VyO1xyXG4gICAgICAgIGFuY2hvck5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoYWZ0ZXJFbCwgYW5jaG9yTm9kZS5uZXh0U2libGluZyk7XHJcbiAgICAgICAgYW5jaG9yTm9kZS5wYXJlbnROb2RlLmluc2VydEJlZm9yZSh0ZXh0LCBhbmNob3JOb2RlLm5leHRTaWJsaW5nKTtcclxuICAgICAgICBhbmNob3JOb2RlLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGJlZm9yZUVsLCBhbmNob3JOb2RlLm5leHRTaWJsaW5nKTtcclxuICAgICAgICBcclxuICAgICAgICAvL0NyZWF0ZSBhIHJhbmdlIGxvY2F0ZWQgYXRlciB0aGUgbWVudGlvblxyXG4gICAgICAgIGxldCByYW5nZSA9IGdldERvY3VtZW50KGlmcmFtZSkuY3JlYXRlUmFuZ2UoKTtcclxuICAgICAgICByYW5nZS5zZWxlY3ROb2RlKGFmdGVyRWwpO1xyXG4gICAgICAgIHJhbmdlLnNldFN0YXJ0KGFmdGVyRWwsIDApO1xyXG4gICAgICAgIHJhbmdlLnNldEVuZChhZnRlckVsLCAwKTtcclxuICAgICAgICBcclxuICAgICAgICAvL01vdmUgdGhlIGN1cnNvciB0byB0aGF0IHNwb3RcclxuICAgICAgICByYW5nZS5jb2xsYXBzZShmYWxzZSk7XHJcbiAgICAgICAgc2VsT2JqLnJlbW92ZUFsbFJhbmdlcygpO1xyXG4gICAgICAgIHNlbE9iai5hZGRSYW5nZShyYW5nZSk7XHJcbiAgICAgIH1cclxuICAgICAgLy92YXIgaHRtbE5vZGUgPSBiZWZvcmVFbC5pbm5lckhUTUwgKyAgdGV4dC5pbm5lckhUTUwgKyBhZnRlckVsLmlubmVySFRNTDtcclxuICAgICAgLy9hbmNob3JOb2RlLnBhcmVudEVsZW1lbnQuaW5uZXJIVE1MID0gIGh0bWxOb2RlO1xyXG4gICAgICAvL2FuY2hvck5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUodGV4dCwgYW5jaG9yTm9kZS5uZXh0U2libGluZyk7XHJcbiAgICAgIC8vYW5jaG9yTm9kZS5wYXJlbnROb2RlLmluc2VydEJlZm9yZSgpIC5pbnNlcnRCZWZvcmUoYmVmb3JlRWwsIGFuY2hvck5vZGUubmV4dFNpYmxpbmcpO1xyXG4gICAgICAvL3JldHVybjtcclxuICAgICAgXHJcbiAgICAgIFxyXG4gICAgfVxyXG4gICAgXHJcbiAgICBleHBvcnQgZnVuY3Rpb24gaXNJbnB1dE9yVGV4dEFyZWFFbGVtZW50KGVsOiBIVE1MRWxlbWVudCk6IGJvb2xlYW4ge1xyXG4gICAgICByZXR1cm4gZWwgIT0gbnVsbCAmJiAoZWwubm9kZU5hbWUgPT0gJ0lOUFVUJyB8fCBlbC5ub2RlTmFtZSA9PSAnVEVYVEFSRUEnKTtcclxuICAgIH07XHJcbiAgICBcclxuICAgIGV4cG9ydCBmdW5jdGlvbiBpc1RleHRFbGVtZW50KGVsOiBIVE1MRWxlbWVudCk6IGJvb2xlYW4ge1xyXG4gICAgICByZXR1cm4gZWwgIT0gbnVsbCAmJiAoZWwubm9kZU5hbWUgPT0gJ0lOUFVUJyB8fCBlbC5ub2RlTmFtZSA9PSAnVEVYVEFSRUEnIHx8IGVsLm5vZGVOYW1lID09ICcjdGV4dCcpO1xyXG4gICAgfTtcclxuICAgIFxyXG4gICAgZXhwb3J0IGZ1bmN0aW9uIHNldENhcmV0UG9zaXRpb24oZWw6IEhUTUxJbnB1dEVsZW1lbnQsIHBvczogbnVtYmVyLCBpZnJhbWU6IEhUTUxJRnJhbWVFbGVtZW50ID0gbnVsbCkge1xyXG4gICAgICAvL2NvbnNvbGUubG9nKFwic2V0Q2FyZXRQb3NpdGlvblwiLCBwb3MsIGVsLCBpZnJhbWU9PW51bGwpO1xyXG4gICAgICBpZiAoaXNJbnB1dE9yVGV4dEFyZWFFbGVtZW50KGVsKSAmJiBlbC5zZWxlY3Rpb25TdGFydCkge1xyXG4gICAgICAgIC8vZWwuZm9jdXMoKTtcclxuICAgICAgICBlbC5zZXRTZWxlY3Rpb25SYW5nZShwb3MsIHBvcyk7XHJcbiAgICAgIH1cclxuICAgICAgZWxzZSB7XHJcbiAgICAgICAgbGV0IHJhbmdlID0gZ2V0RG9jdW1lbnQoaWZyYW1lKS5jcmVhdGVSYW5nZSgpO1xyXG4gICAgICAgIHJhbmdlLnNldFN0YXJ0KGVsLCBwb3MpO1xyXG4gICAgICAgIHJhbmdlLmNvbGxhcHNlKHRydWUpO1xyXG4gICAgICAgIGxldCBzZWwgPSBnZXRXaW5kb3dTZWxlY3Rpb24oaWZyYW1lKTtcclxuICAgICAgICBzZWwucmVtb3ZlQWxsUmFuZ2VzKCk7XHJcbiAgICAgICAgc2VsLmFkZFJhbmdlKHJhbmdlKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgXHJcbiAgICBleHBvcnQgZnVuY3Rpb24gZ2V0Q2FyZXRQb3NpdGlvbihlbDogSFRNTElucHV0RWxlbWVudCwgaWZyYW1lOiBIVE1MSUZyYW1lRWxlbWVudCA9IG51bGwpIHtcclxuICAgICAgLy9jb25zb2xlLmxvZyhcImdldENhcmV0UG9zaXRpb25cIiwgZWwpO1xyXG4gICAgICBpZiAoaXNJbnB1dE9yVGV4dEFyZWFFbGVtZW50KGVsKSkge1xyXG4gICAgICAgIHZhciB2YWwgPSBlbC52YWx1ZTtcclxuICAgICAgICByZXR1cm4gdmFsLnNsaWNlKDAsIGVsLnNlbGVjdGlvblN0YXJ0KS5sZW5ndGg7XHJcbiAgICAgIH1cclxuICAgICAgZWxzZSB7XHJcbiAgICAgICAgdmFyIHNlbE9iaiA9IGdldFdpbmRvd1NlbGVjdGlvbihpZnJhbWUpOyAvL3dpbmRvdy5nZXRTZWxlY3Rpb24oKTtcclxuICAgICAgICBpZiAoc2VsT2JqLnJhbmdlQ291bnQgPiAwKSB7XHJcbiAgICAgICAgICB2YXIgc2VsUmFuZ2UgPSBzZWxPYmouZ2V0UmFuZ2VBdCgwKTtcclxuICAgICAgICAgIHZhciBwcmVDYXJldFJhbmdlID0gc2VsUmFuZ2UuY2xvbmVSYW5nZSgpO1xyXG4gICAgICAgICAgcHJlQ2FyZXRSYW5nZS5zZWxlY3ROb2RlQ29udGVudHMoZWwpO1xyXG4gICAgICAgICAgcHJlQ2FyZXRSYW5nZS5zZXRFbmQoc2VsUmFuZ2UuZW5kQ29udGFpbmVyLCBzZWxSYW5nZS5lbmRPZmZzZXQpO1xyXG4gICAgICAgICAgdmFyIHBvc2l0aW9uID0gcHJlQ2FyZXRSYW5nZS50b1N0cmluZygpLmxlbmd0aDtcclxuICAgICAgICAgIHJldHVybiBwb3NpdGlvbjtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIFxyXG4gICAgLy8gQmFzZWQgb24gbWVudC5pbyBmdW5jdGlvbnMuLi5cclxuICAgIC8vXHJcbiAgICBcclxuICAgIGZ1bmN0aW9uIGdldERvY3VtZW50KGlmcmFtZTogSFRNTElGcmFtZUVsZW1lbnQpIHtcclxuICAgICAgaWYgKCFpZnJhbWUpIHtcclxuICAgICAgICByZXR1cm4gZG9jdW1lbnQ7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmV0dXJuIGlmcmFtZS5jb250ZW50V2luZG93LmRvY3VtZW50O1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGZ1bmN0aW9uIGdldFdpbmRvd1NlbGVjdGlvbihpZnJhbWU6IEhUTUxJRnJhbWVFbGVtZW50KTogU2VsZWN0aW9uIHtcclxuICAgICAgaWYgKCFpZnJhbWUpIHtcclxuICAgICAgICAvL2NvbnNvbGUubG9nKHdpbmRvdy5nZXRTZWxlY3Rpb24oKSk7XHJcbiAgICAgICAgcmV0dXJuIHdpbmRvdy5nZXRTZWxlY3Rpb24oKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICByZXR1cm4gaWZyYW1lLmNvbnRlbnRXaW5kb3cuZ2V0U2VsZWN0aW9uKCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIFxyXG4gICAgZXhwb3J0IGZ1bmN0aW9uIGdldENvbnRlbnRFZGl0YWJsZUNhcmV0Q29vcmRzKGN0eDogeyBpZnJhbWU6IEhUTUxJRnJhbWVFbGVtZW50LCBwYXJlbnQ/OiBFbGVtZW50IH0pIHtcclxuICAgICAgbGV0IG1hcmtlclRleHRDaGFyID0gJ1xcdWZlZmYnO1xyXG4gICAgICBsZXQgbWFya2VySWQgPSAnc2VsXycgKyBuZXcgRGF0ZSgpLmdldFRpbWUoKSArICdfJyArIE1hdGgucmFuZG9tKCkudG9TdHJpbmcoKS5zdWJzdHIoMik7XHJcbiAgICAgIGxldCBkb2MgPSBnZXREb2N1bWVudChjdHggPyBjdHguaWZyYW1lIDogbnVsbCk7XHJcbiAgICAgIGxldCBzZWwgPSBnZXRXaW5kb3dTZWxlY3Rpb24oY3R4ID8gY3R4LmlmcmFtZSA6IG51bGwpO1xyXG4gICAgICBsZXQgcHJldlJhbmdlID0gc2VsLmdldFJhbmdlQXQoMCk7XHJcbiAgICAgIFxyXG4gICAgICAvLyBjcmVhdGUgbmV3IHJhbmdlIGFuZCBzZXQgcG9zdGlvbiB1c2luZyBwcmV2UmFuZ2VcclxuICAgICAgbGV0IHJhbmdlID0gZG9jLmNyZWF0ZVJhbmdlKCk7XHJcbiAgICAgIHJhbmdlLnNldFN0YXJ0KHNlbC5hbmNob3JOb2RlLCBwcmV2UmFuZ2Uuc3RhcnRPZmZzZXQpO1xyXG4gICAgICByYW5nZS5zZXRFbmQoc2VsLmFuY2hvck5vZGUsIHByZXZSYW5nZS5zdGFydE9mZnNldCk7XHJcbiAgICAgIHJhbmdlLmNvbGxhcHNlKGZhbHNlKTtcclxuICAgICAgXHJcbiAgICAgIC8vIENyZWF0ZSB0aGUgbWFya2VyIGVsZW1lbnQgY29udGFpbmluZyBhIHNpbmdsZSBpbnZpc2libGUgY2hhcmFjdGVyXHJcbiAgICAgIC8vIHVzaW5nIERPTSBtZXRob2RzIGFuZCBpbnNlcnQgaXQgYXQgdGhlIHBvc2l0aW9uIGluIHRoZSByYW5nZVxyXG4gICAgICBsZXQgbWFya2VyRWwgPSBkb2MuY3JlYXRlRWxlbWVudCgnc3BhbicpO1xyXG4gICAgICBtYXJrZXJFbC5pZCA9IG1hcmtlcklkO1xyXG4gICAgICBtYXJrZXJFbC5hcHBlbmRDaGlsZChkb2MuY3JlYXRlVGV4dE5vZGUobWFya2VyVGV4dENoYXIpKTtcclxuICAgICAgcmFuZ2UuaW5zZXJ0Tm9kZShtYXJrZXJFbCk7XHJcbiAgICAgIHNlbC5yZW1vdmVBbGxSYW5nZXMoKTtcclxuICAgICAgc2VsLmFkZFJhbmdlKHByZXZSYW5nZSk7XHJcbiAgICAgIFxyXG4gICAgICBsZXQgY29vcmRpbmF0ZXMgPSB7XHJcbiAgICAgICAgbGVmdDogMCxcclxuICAgICAgICB0b3A6IG1hcmtlckVsLm9mZnNldEhlaWdodFxyXG4gICAgICB9O1xyXG4gICAgICBcclxuICAgICAgbG9jYWxUb1JlbGF0aXZlQ29vcmRpbmF0ZXMoY3R4LCBtYXJrZXJFbCwgY29vcmRpbmF0ZXMpO1xyXG4gICAgICBcclxuICAgICAgbWFya2VyRWwucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChtYXJrZXJFbCk7XHJcbiAgICAgIHJldHVybiBjb29yZGluYXRlcztcclxuICAgIH1cclxuICAgIFxyXG4gICAgZnVuY3Rpb24gbG9jYWxUb1JlbGF0aXZlQ29vcmRpbmF0ZXMoXHJcbiAgICAgIGN0eDogeyBpZnJhbWU6IEhUTUxJRnJhbWVFbGVtZW50LCBwYXJlbnQ/OiBFbGVtZW50IH0sXHJcbiAgICAgIGVsZW1lbnQ6IEVsZW1lbnQsXHJcbiAgICAgIGNvb3JkaW5hdGVzOiB7IHRvcDogbnVtYmVyOyBsZWZ0OiBudW1iZXIgfVxyXG4gICAgICApIHtcclxuICAgICAgICBsZXQgb2JqID0gPEhUTUxFbGVtZW50PmVsZW1lbnQ7XHJcbiAgICAgICAgbGV0IGlmcmFtZSA9IGN0eCA/IGN0eC5pZnJhbWUgOiBudWxsO1xyXG4gICAgICAgIHdoaWxlIChvYmopIHtcclxuICAgICAgICAgIGlmIChjdHgucGFyZW50ICE9IG51bGwgJiYgY3R4LnBhcmVudCA9PSBvYmopIHtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBjb29yZGluYXRlcy5sZWZ0ICs9IG9iai5vZmZzZXRMZWZ0ICsgb2JqLmNsaWVudExlZnQ7XHJcbiAgICAgICAgICBjb29yZGluYXRlcy50b3AgKz0gb2JqLm9mZnNldFRvcCArIG9iai5jbGllbnRUb3A7XHJcbiAgICAgICAgICBvYmogPSA8SFRNTEVsZW1lbnQ+b2JqLm9mZnNldFBhcmVudDtcclxuICAgICAgICAgIGlmICghb2JqICYmIGlmcmFtZSkge1xyXG4gICAgICAgICAgICBvYmogPSBpZnJhbWU7XHJcbiAgICAgICAgICAgIGlmcmFtZSA9IG51bGw7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIG9iaiA9IDxIVE1MRWxlbWVudD5lbGVtZW50O1xyXG4gICAgICAgIGlmcmFtZSA9IGN0eCA/IGN0eC5pZnJhbWUgOiBudWxsO1xyXG4gICAgICAgIHdoaWxlIChvYmogIT09IGdldERvY3VtZW50KG51bGwpLmJvZHkgJiYgb2JqICE9IG51bGwpIHtcclxuICAgICAgICAgIGlmIChjdHgucGFyZW50ICE9IG51bGwgJiYgY3R4LnBhcmVudCA9PSBvYmopIHtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBpZiAob2JqLnNjcm9sbFRvcCAmJiBvYmouc2Nyb2xsVG9wID4gMCkge1xyXG4gICAgICAgICAgICBjb29yZGluYXRlcy50b3AgLT0gb2JqLnNjcm9sbFRvcDtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGlmIChvYmouc2Nyb2xsTGVmdCAmJiBvYmouc2Nyb2xsTGVmdCA+IDApIHtcclxuICAgICAgICAgICAgY29vcmRpbmF0ZXMubGVmdCAtPSBvYmouc2Nyb2xsTGVmdDtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIG9iaiA9IDxIVE1MRWxlbWVudD5vYmoucGFyZW50Tm9kZTtcclxuICAgICAgICAgIGlmICghb2JqICYmIGlmcmFtZSkge1xyXG4gICAgICAgICAgICBvYmogPSBpZnJhbWU7XHJcbiAgICAgICAgICAgIGlmcmFtZSA9IG51bGw7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgICJdfQ==