const a6_0x40fc=['nxCloudAccessToken','then','note','Starting\x20an\x20agent\x20for\x20running\x20Nx\x20tasks','executeTasks','tasksRunnerOptions','join','argv','message','__awaiter','random','End\x20all\x20currently\x20running\x20agents,\x20run\x20\x22npx\x20nx-cloud\x20clean-up-agents\x22,\x20and\x20try\x20again.','dte-agent','printInvalidRunnerError','targets','encryptionKey','includes','Critical\x20Error\x20in\x20Agent:\x20\x22','../../../utilities/nx-imports-light','ErrorReporterApi','Distributed\x20Task\x20Execution\x20is\x20disabled\x20when\x20your\x20workspace\x20is\x20disabled','../../error/print-cacheable-targets-error','printRunGroupError','cacheableOperations','catch','../../../utilities/environment','canDetectRunGroup','./execute-tasks','some','../../error/print-invalid-runner-error','warn','Agent\x20was\x20terminated\x20via\x20SIGINT','NX_AGENT_NAME','Agent\x20was\x20terminated\x20via\x20SIGTERM','apply','This\x20can\x20also\x20be\x20a\x20false\x20positive\x20caused\x20by\x20agents\x20that\x20did\x20not\x20shut\x20down\x20correctly.','isWorkspaceEnabled','./distributed-agent.api','./invoke-tasks-using-run-many','filter','completeRunGroupWithError','printCacheableTargetsError','We\x20have\x20detected\x20other\x20agents\x20running\x20in\x20this\x20workspace.\x20This\x20can\x20cause\x20unexpected\x20behavior.','length','getCloudOptions','If\x20you\x20believe\x20this\x20is\x20the\x20case,\x20run\x20\x22npx\x20nx-cloud\x20clean-up-agents\x22.','mkdirSync','split','done','env','runner','DteArtifactStorage','map','getBranch','submitRunMetrics','getCIExecutionEnv','__esModule','Duplicate\x20Agent\x20ID\x20Detected','nx-cloud','startAgent','error','getRunGroup','floor','.lock','FileStorage','../../../utilities/metric-logger','next','default','throw','../../error/print-run-group-error','defineProperty','CIRCLE_STAGE','SIGINT','../../file-storage/file-storage','exit','E2EEncryption','Other\x20Nx\x20Cloud\x20Agents\x20Detected','CIRCLECI','CIRCLE_JOB','Starting\x20an\x20agent\x20for\x20running\x20Nx\x20target(s)\x20[','value','We\x20have\x20detected\x20another\x20agent\x20with\x20this\x20ID\x20running\x20in\x20this\x20workspace.\x20This\x20should\x20not\x20happen.','existsSync'];(function(_0x973931,_0x40fc51){const _0x1e4082=function(_0x178eb2){while(--_0x178eb2){_0x973931['push'](_0x973931['shift']());}};_0x1e4082(++_0x40fc51);}(a6_0x40fc,0x8b));const a6_0x1e40=function(_0x973931,_0x40fc51){_0x973931=_0x973931-0x0;let _0x1e4082=a6_0x40fc[_0x973931];return _0x1e4082;};'use strict';var __awaiter=this&&this[a6_0x1e40('0x24')]||function(_0x1f69e0,_0x5473f5,_0xd01843,_0xfb08fe){function _0x162764(_0x4fbacd){return _0x4fbacd instanceof _0xd01843?_0x4fbacd:new _0xd01843(function(_0x2c3dc7){_0x2c3dc7(_0x4fbacd);});}return new(_0xd01843||(_0xd01843=Promise))(function(_0x14b370,_0x467968){function _0x22fcbb(_0xca67d8){try{_0xbaa560(_0xfb08fe[a6_0x1e40('0xa')](_0xca67d8));}catch(_0x14d0bf){_0x467968(_0x14d0bf);}}function _0x5dbf51(_0x4b016f){try{_0xbaa560(_0xfb08fe[a6_0x1e40('0xc')](_0x4b016f));}catch(_0x233ba6){_0x467968(_0x233ba6);}}function _0xbaa560(_0x1a0013){_0x1a0013[a6_0x1e40('0x4b')]?_0x14b370(_0x1a0013[a6_0x1e40('0x18')]):_0x162764(_0x1a0013['value'])['then'](_0x22fcbb,_0x5dbf51);}_0xbaa560((_0xfb08fe=_0xfb08fe[a6_0x1e40('0x3d')](_0x1f69e0,_0x5473f5||[]))[a6_0x1e40('0xa')]());});};Object[a6_0x1e40('0xe')](exports,a6_0x1e40('0x0'),{'value':!![]});exports[a6_0x1e40('0x3')]=void 0x0;const fs_1=require('fs');const yargsParser=require('yargs-parser');const dte_artifact_storage_1=require('../../../utilities/dte-artifact-storage');const environment_1=require(a6_0x1e40('0x34'));const get_cloud_options_1=require('../../../utilities/get-cloud-options');const is_workspace_enabled_1=require('../../../utilities/is-workspace-enabled');const metric_logger_1=require(a6_0x1e40('0x9'));const error_reporter_api_1=require('../../api/error-reporter.api');const print_cacheable_targets_error_1=require(a6_0x1e40('0x30'));const print_invalid_runner_error_1=require(a6_0x1e40('0x38'));const print_run_group_error_1=require(a6_0x1e40('0xd'));const e2e_encryption_1=require('../../file-storage/e2e-encryption');const file_storage_1=require(a6_0x1e40('0x11'));const distributed_agent_api_1=require(a6_0x1e40('0x40'));const execute_tasks_1=require(a6_0x1e40('0x36'));const invoke_tasks_using_nx_imperative_api_1=require('./invoke-tasks-using-nx-imperative-api');const invoke_tasks_using_run_many_1=require(a6_0x1e40('0x41'));const {output}=require(a6_0x1e40('0x2d'));const {initTasksRunner,cacheDirectory}=require('../../../utilities/nx-imports');const args=yargsParser(process[a6_0x1e40('0x22')],{'array':[a6_0x1e40('0x29')],'default':{}});if(args[a6_0x1e40('0x29')]&&args[a6_0x1e40('0x29')][a6_0x1e40('0x46')]===0x1){args[a6_0x1e40('0x29')]=args[a6_0x1e40('0x29')][0x0][a6_0x1e40('0x4a')](',')[a6_0x1e40('0x4f')](_0x5b104e=>_0x5b104e['trim']());}function startAgent(){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x1a2e6d=(0x0,environment_1[a6_0x1e40('0x50')])();const _0x5d52a1=(0x0,environment_1[a6_0x1e40('0x5')])();const _0x19b5ef=(0x0,environment_1['getCIExecutionId'])();const _0xde99cd=(0x0,environment_1[a6_0x1e40('0x52')])();if(!(0x0,print_run_group_error_1[a6_0x1e40('0x35')])(_0x5d52a1,_0x19b5ef)){(0x0,print_run_group_error_1[a6_0x1e40('0x31')])();process[a6_0x1e40('0x12')](0x1);}if(args[a6_0x1e40('0x29')]&&args[a6_0x1e40('0x29')]['length']){output['note']({'title':a6_0x1e40('0x17')+args[a6_0x1e40('0x29')][a6_0x1e40('0x21')](',\x20')+']'});}else{output[a6_0x1e40('0x1d')]({'title':a6_0x1e40('0x1e')});}const {nxJson,nxCloudOptions:_0x2cd033}=(0x0,get_cloud_options_1[a6_0x1e40('0x47')])(a6_0x1e40('0xb'));function _0x1875cd(){var _0x116814;const _0x6e2adb=(_0x116814=nxJson[a6_0x1e40('0x20')])===null||_0x116814===void 0x0?void 0x0:_0x116814['default'];if(nxJson[a6_0x1e40('0x1b')]&&!_0x6e2adb){return!![];}return!(_0x6e2adb===null||_0x6e2adb===void 0x0?void 0x0:_0x6e2adb['runner'])&&process[a6_0x1e40('0x4c')]['NX_CLOUD_ACCESS_TOKEN']||!(_0x6e2adb===null||_0x6e2adb===void 0x0?void 0x0:_0x6e2adb['runner'])&&nxJson['nxCloudAccessToken']||(_0x6e2adb===null||_0x6e2adb===void 0x0?void 0x0:_0x6e2adb[a6_0x1e40('0x4d')])===a6_0x1e40('0x2')||(_0x6e2adb===null||_0x6e2adb===void 0x0?void 0x0:_0x6e2adb[a6_0x1e40('0x4d')])==='@nrwl/nx-cloud';}if(!_0x1875cd()){(0x0,print_invalid_runner_error_1[a6_0x1e40('0x28')])();return process['exit'](0x1);}if(args['targets']&&args['targets'][a6_0x1e40('0x37')](_0x3c05b2=>{var _0x59c2c3;return!((_0x59c2c3=_0x2cd033[a6_0x1e40('0x32')])===null||_0x59c2c3===void 0x0?void 0x0:_0x59c2c3['includes'](_0x3c05b2));})){const _0x27dd26=args[a6_0x1e40('0x29')][a6_0x1e40('0x42')](_0x298442=>{var _0x5561f9;return!((_0x5561f9=_0x2cd033[a6_0x1e40('0x32')])===null||_0x5561f9===void 0x0?void 0x0:_0x5561f9[a6_0x1e40('0x2b')](_0x298442));});(0x0,print_cacheable_targets_error_1[a6_0x1e40('0x44')])(_0x27dd26);return process[a6_0x1e40('0x12')](0x1);}const _0x518de8=yield(0x0,is_workspace_enabled_1[a6_0x1e40('0x3f')])(_0x2cd033);if(!_0x518de8){output[a6_0x1e40('0x4')]({'title':'Nx\x20Cloud:\x20Workspace\x20is\x20disabled','bodyLines':[a6_0x1e40('0x2f'),'','Organization\x20administrators\x20can\x20find\x20more\x20information\x20on\x20the\x20\x27Billing\x27\x20page\x20in\x20the\x20Nx\x20Cloud\x20Webapp']});process[a6_0x1e40('0x12')](0x1);}const _0x450f7d=getAgentName();const _0x3c5fc1=new distributed_agent_api_1['DistributedAgentApi'](_0x2cd033,_0x1a2e6d,_0x5d52a1,_0x19b5ef,_0xde99cd,_0x450f7d);createAgentLockfileAndSetUpListeners(_0x3c5fc1,_0x2cd033,_0x450f7d);const _0x1fd3c2=new e2e_encryption_1[(a6_0x1e40('0x13'))](environment_1['ENCRYPTION_KEY']||_0x2cd033[a6_0x1e40('0x2a')]);const _0x29bf86=new error_reporter_api_1[(a6_0x1e40('0x2e'))](_0x2cd033);const _0x39e5c0=new dte_artifact_storage_1[(a6_0x1e40('0x4e'))](new file_storage_1[(a6_0x1e40('0x8'))](_0x1fd3c2,_0x29bf86,_0x2cd033,a6_0x1e40('0x27')),cacheDirectory);const _0x214aad=initTasksRunner?yield(0x0,invoke_tasks_using_nx_imperative_api_1['invokeTasksUsingNxImperativeApi'])(_0x2cd033):yield(0x0,invoke_tasks_using_run_many_1['invokeTasksUsingRunMany'])();return(0x0,execute_tasks_1[a6_0x1e40('0x1f')])(_0x450f7d,_0x3c5fc1,_0x39e5c0,_0x214aad,args['targets'])[a6_0x1e40('0x1c')](_0x1278ff=>__awaiter(this,void 0x0,void 0x0,function*(){yield(0x0,metric_logger_1[a6_0x1e40('0x51')])(_0x2cd033);return _0x1278ff;}))[a6_0x1e40('0x33')](_0xb946da=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x3c5fc1[a6_0x1e40('0x43')](a6_0x1e40('0x2c')+_0xb946da[a6_0x1e40('0x23')]+'\x22');throw _0xb946da;}));});}exports[a6_0x1e40('0x3')]=startAgent;function getAgentName(){if(process[a6_0x1e40('0x4c')][a6_0x1e40('0x3b')]!==undefined){return process[a6_0x1e40('0x4c')][a6_0x1e40('0x3b')];}else if(process[a6_0x1e40('0x4c')][a6_0x1e40('0x15')]!==undefined&&process[a6_0x1e40('0x4c')][a6_0x1e40('0xf')]){return process[a6_0x1e40('0x4c')][a6_0x1e40('0xf')];}else if(process['env'][a6_0x1e40('0x15')]!==undefined&&process[a6_0x1e40('0x4c')][a6_0x1e40('0x16')]){return process[a6_0x1e40('0x4c')][a6_0x1e40('0x16')];}else{return'Agent\x20'+Math[a6_0x1e40('0x6')](Math[a6_0x1e40('0x25')]()*0x186a0);}}function createAgentLockfileAndSetUpListeners(_0x562d7a,_0x138402,_0x2546b4){const _0x4d54f8=cacheDirectory+'/lockfiles';const _0xa9d635=_0x4d54f8+'/'+_0x2546b4+a6_0x1e40('0x7');if(!(0x0,fs_1['existsSync'])(_0x4d54f8)){(0x0,fs_1[a6_0x1e40('0x49')])(_0x4d54f8,{'recursive':!![]});}const _0x5be956=(0x0,fs_1['readdirSync'])(_0x4d54f8);if(_0x5be956[a6_0x1e40('0x46')]){if(_0x5be956[a6_0x1e40('0x2b')](_0x2546b4+a6_0x1e40('0x7'))){output[a6_0x1e40('0x4')]({'title':a6_0x1e40('0x1'),'bodyLines':[a6_0x1e40('0x19'),'',a6_0x1e40('0x26')]});process[a6_0x1e40('0x12')](0x1);}output[a6_0x1e40('0x39')]({'title':a6_0x1e40('0x14'),'bodyLines':[a6_0x1e40('0x45'),'',a6_0x1e40('0x3e'),a6_0x1e40('0x48')]});}(0x0,fs_1['writeFileSync'])(_0xa9d635,'');process['on'](a6_0x1e40('0x12'),_0x35619b=>{cleanupAgentLockfile(_0xa9d635,_0x35619b);});process['on']('SIGTERM',()=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x562d7a[a6_0x1e40('0x43')](a6_0x1e40('0x3c'));cleanupAgentLockfile(_0xa9d635,0x1);}));process['on'](a6_0x1e40('0x10'),()=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x562d7a[a6_0x1e40('0x43')](a6_0x1e40('0x3a'));cleanupAgentLockfile(_0xa9d635,0x1);}));}function cleanupAgentLockfile(_0x51355e,_0x208449){if((0x0,fs_1[a6_0x1e40('0x1a')])(_0x51355e)){(0x0,fs_1['unlinkSync'])(_0x51355e);process['exit'](_0x208449);}}