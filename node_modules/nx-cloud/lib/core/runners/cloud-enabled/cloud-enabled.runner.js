const a1_0x126b=['CloudRemoteCache','EndOfRunMessage','parseCommand','hash','getRunGroup','find','catch','stringify','__awaiter','pathExists','filter','defineProperty','throw','Nx\x20Cloud\x20wasn\x27t\x20able\x20to\x20store\x20artifacts.','daemon','../../terminal-output/message-reporter','enabled','ENCRYPTION_KEY','../../file-storage/e2e-encryption','../../terminal-output/end-of-run-message','encryptionKey','requests','join','warn','url','submitRunMetrics','Nx\x20Cloud\x20wasn\x27t\x20able\x20to\x20record\x20its\x20run.','endRun','message','cacheStatus','error','map','value','apply','resolve','taskId','obfuscate','exit','done','OutputObfuscator','../../file-storage/file-storage','../../../utilities/metric-logger','__esModule','lifeCycle','note','processInBackground','complete','../../api/error-reporter.api','DISTRIBUTED_TASK_EXECUTION_INTERNAL_ERROR_STATUS_CODE','accessToken','agentRunningInDistributedExecution','CloudEnabledLifeCycle','ErrorReporterApi','./cloud-run.api','skipNxCache','./cloud-enabled-life-cycle','length','all','forEach','ACCESS_TOKEN','../../../utilities/nx-imports-light','getBranch','printMessages','tasks-hashes-','E2EEncryption','Executed\x20tasks\x20with\x20hashes:\x20','FileStorage','/runs/','waitForStoreRequestsToComplete','Task\x20with\x20hash\x20','then','env','../../../utilities/nx-imports','Nx\x20Cloud\x20Problems','runUrl','push','toISOString','path','toString','storedHashes','anyErrors','../../../utilities/environment','.commit','next','./cloud-remote-cache','NX_CLOUD_DISTRIBUTED_EXECUTION_ID','maskedProperties','cloud-enabled-runner','assign','https://nx.app','\x20isn\x27t\x20recorded','./id-generator','local-cache-hit','subscribe'];(function(_0x1d9853,_0x126b59){const _0x2258eb=function(_0x2b619e){while(--_0x2b619e){_0x1d9853['push'](_0x1d9853['shift']());}};_0x2258eb(++_0x126b59);}(a1_0x126b,0xe0));const a1_0x2258=function(_0x1d9853,_0x126b59){_0x1d9853=_0x1d9853-0x0;let _0x2258eb=a1_0x126b[_0x1d9853];return _0x2258eb;};'use strict';var __awaiter=this&&this[a1_0x2258('0x42')]||function(_0x3c3f21,_0xdceb35,_0x17bd46,_0x5337e5){function _0xd5b529(_0x5f241d){return _0x5f241d instanceof _0x17bd46?_0x5f241d:new _0x17bd46(function(_0x33feea){_0x33feea(_0x5f241d);});}return new(_0x17bd46||(_0x17bd46=Promise))(function(_0x2e528f,_0x329b66){function _0x39bdee(_0xe1f71d){try{_0x4e7d9a(_0x5337e5[a1_0x2258('0x2f')](_0xe1f71d));}catch(_0xb656c1){_0x329b66(_0xb656c1);}}function _0x36b7cf(_0x2b1060){try{_0x4e7d9a(_0x5337e5[a1_0x2258('0x46')](_0x2b1060));}catch(_0x1ad6d8){_0x329b66(_0x1ad6d8);}}function _0x4e7d9a(_0x57afda){_0x57afda[a1_0x2258('0x2')]?_0x2e528f(_0x57afda[a1_0x2258('0x5a')]):_0xd5b529(_0x57afda[a1_0x2258('0x5a')])[a1_0x2258('0x22')](_0x39bdee,_0x36b7cf);}_0x4e7d9a((_0x5337e5=_0x5337e5[a1_0x2258('0x5b')](_0x3c3f21,_0xdceb35||[]))['next']());});};Object[a1_0x2258('0x45')](exports,a1_0x2258('0x6'),{'value':!![]});exports['cloudEnabledTasksRunner']=void 0x0;const fs_1=require('fs');const fs_extra_1=require('fs-extra');const path=require('path');const path_1=require(a1_0x2258('0x29'));const environment_1=require(a1_0x2258('0x2d'));const metric_logger_1=require(a1_0x2258('0x5'));const remove_trailing_slash_1=require('../../../utilities/remove-trailing-slash');const error_reporter_api_1=require(a1_0x2258('0xb'));const e2e_encryption_1=require(a1_0x2258('0x4c'));const file_storage_1=require(a1_0x2258('0x4'));const end_of_run_message_1=require(a1_0x2258('0x4d'));const message_reporter_1=require(a1_0x2258('0x49'));const output_obfuscator_1=require('../../terminal-output/output-obfuscator');const cloud_enabled_life_cycle_1=require(a1_0x2258('0x13'));const cloud_remote_cache_1=require(a1_0x2258('0x30'));const cloud_run_api_1=require(a1_0x2258('0x11'));const id_generator_1=require(a1_0x2258('0x37'));const {output}=require(a1_0x2258('0x18'));const {tasksRunner,cacheDirectory}=require(a1_0x2258('0x24'));function createApi(_0x22a302,_0x5cf32a,_0x1f23a9){const _0x11dd50=(0x0,environment_1['getMachineInfo'])();return new cloud_run_api_1['CloudRunApi'](_0x22a302,_0x1f23a9,_0x5cf32a,_0x11dd50);}function storeTaskHashes(_0x1c41aa,_0x9ace78,_0x22c26c){const _0x3dbb40=JSON[a1_0x2258('0x41')](_0x1c41aa[a1_0x2258('0x59')](_0x50433f=>({'taskId':_0x50433f[a1_0x2258('0x5d')],'hash':_0x50433f[a1_0x2258('0x3d')]})));if(environment_1['VERBOSE_LOGGING']){output[a1_0x2258('0x8')]({'title':a1_0x2258('0x1d')+_0x3dbb40});}(0x0,fs_1['writeFileSync'])(path[a1_0x2258('0x50')](_0x9ace78,a1_0x2258('0x1b')+_0x22c26c),_0x3dbb40);}function storeLocalCacheHits(_0x3225ce,_0x3bcc74,_0x50101f){const _0x45ab70=_0x3225ce[a1_0x2258('0x44')](_0x1a158f=>_0x1a158f[a1_0x2258('0x57')]===a1_0x2258('0x38'))[a1_0x2258('0x59')](_0x18a900=>_0x18a900[a1_0x2258('0x3d')]);_0x45ab70[a1_0x2258('0x16')](_0x460a35=>_0x3bcc74['store'](_0x460a35,_0x50101f));}function onComplete(_0xeb4f2e){return __awaiter(this,arguments,void 0x0,function*({daemon,options,fileStorage,remoteCache,api,outputObfuscator,runStartTime,messages,endOfRunMessage,taskExecutions,versionOfNxBefore133,inner,encryptionKey,storeInCurrentProcess,distributedExecutionId,runContext}){const _0x2b80eb=new Date()[a1_0x2258('0x28')]();const _0x5cf170=(0x0,environment_1[a1_0x2258('0x19')])();const _0x152517={'command':outputObfuscator[a1_0x2258('0x0')]((0x0,environment_1[a1_0x2258('0x3c')])()),'startTime':runStartTime,'endTime':_0x2b80eb,'distributedExecutionId':distributedExecutionId,'branch':_0x5cf170,'runGroup':(0x0,environment_1[a1_0x2258('0x3e')])(),'sha':_0x5cf170?(0x0,environment_1['extractGitSha'])():undefined,'inner':inner};const _0xffe157={'branch':_0x5cf170,'runGroup':(0x0,environment_1['getRunGroup'])(),'ciExecutionId':(0x0,environment_1['getCIExecutionId'])(),'ciExecutionEnv':(0x0,environment_1['getCIExecutionEnv'])()};if(storeInCurrentProcess){if((0x0,environment_1[a1_0x2258('0xe')])(distributedExecutionId)){storeTaskHashes(taskExecutions,cacheDirectory,distributedExecutionId);storeLocalCacheHits(taskExecutions,remoteCache,cacheDirectory);}try{yield remoteCache[a1_0x2258('0x20')]();}catch(_0x43bcb0){output[a1_0x2258('0x58')]({'title':a1_0x2258('0x47')});messages[a1_0x2258('0x1a')]();return![];}for(const _0x1b5add of fileStorage[a1_0x2258('0x2b')]){const _0x469a7d=taskExecutions[a1_0x2258('0x3f')](_0x26aa17=>_0x26aa17[a1_0x2258('0x3d')]===_0x1b5add);if(!_0x469a7d){throw new Error(a1_0x2258('0x21')+_0x1b5add+a1_0x2258('0x36'));}_0x469a7d['uploadedToStorage']=!![];}try{yield api[a1_0x2258('0x55')](_0x152517,taskExecutions,_0xffe157);}catch(_0x15e221){output['error']({'title':a1_0x2258('0x54')});messages['printMessages']();return![];}yield(0x0,metric_logger_1[a1_0x2258('0x53')])(options);}else{try{const _0x388394=environment_1[a1_0x2258('0x17')]?environment_1['ACCESS_TOKEN']:options[a1_0x2258('0xd')];const _0x501236=(0x0,id_generator_1['generateUniqueLinkId'])();const _0x3f256e=require[a1_0x2258('0x5c')]('nx-cloud/lib/daemon/process-run-end');yield daemon[a1_0x2258('0x9')](_0x3f256e,{'encryptionKey':encryptionKey,'runnerOptions':Object['assign'](Object[a1_0x2258('0x34')]({},options),{'accessToken':_0x388394}),'delayedStoreRequests':remoteCache['delayedStoreRequests'],'ciExecutionContext':_0xffe157,'runEnd':{'runData':_0x152517,'taskExecutions':taskExecutions,'linkId':_0x501236}});runContext[a1_0x2258('0x26')]=(0x0,remove_trailing_slash_1['removeTrailingSlash'])(options[a1_0x2258('0x52')]||a1_0x2258('0x35'))+a1_0x2258('0x1f')+_0x501236;}catch(_0x5a3380){output[a1_0x2258('0x51')]({'title':a1_0x2258('0x25'),'bodyLines':[_0x5a3380[a1_0x2258('0x56')]||_0x5a3380[a1_0x2258('0x2a')]()]});return![];}}if(versionOfNxBefore133){setTimeout(()=>{messages['printMessages']();if(!messages[a1_0x2258('0x2c')]&&!inner){endOfRunMessage['printCacheHitsMessage']();}},0x0);}else{messages[a1_0x2258('0x1a')]();if(!messages[a1_0x2258('0x2c')]&&!inner){endOfRunMessage['printCacheHitsMessage']();}}return!![];});}function createLifeCycle(_0x287009,_0x63315b,_0x27d484,_0x591b57){const _0x252ad9=new cloud_enabled_life_cycle_1[(a1_0x2258('0xf'))](_0x287009,cacheDirectory,!![],_0x63315b['cacheableOperations']||[],_0x27d484,_0x591b57);try{const {CompositeLifeCycle}=require(a1_0x2258('0x24'));if(!CompositeLifeCycle)return _0x252ad9;return new CompositeLifeCycle([_0x63315b[a1_0x2258('0x7')],_0x252ad9]);}catch(_0x58f1fa){return _0x252ad9;}}function fetchUrlsForKnownHashesUpfront(_0x2d847e,_0x4ded22,_0xf1f80a,_0x26cc95,_0x50bf7e){return __awaiter(this,void 0x0,void 0x0,function*(){if(_0x26cc95[a1_0x2258('0x12')])return;let _0x49b333=_0xf1f80a[a1_0x2258('0x59')](_0x3529b5=>_0x3529b5[a1_0x2258('0x3d')])['filter'](_0xd3982e=>!!_0xd3982e);const _0x53ec5e=yield Promise[a1_0x2258('0x15')](_0x49b333[a1_0x2258('0x59')](_0x285dc6=>{const _0x466bc8=(0x0,path_1['join'])(cacheDirectory,_0x285dc6+a1_0x2258('0x2e'));return(0x0,fs_extra_1[a1_0x2258('0x43')])(_0x466bc8);}));const _0x1fe91d=[];for(let _0x1d8373=0x0;_0x1d8373<_0x53ec5e[a1_0x2258('0x14')];++_0x1d8373){if(!_0x53ec5e[_0x1d8373]){_0x1fe91d[a1_0x2258('0x27')](_0x49b333[_0x1d8373]);}}if(_0x1fe91d[a1_0x2258('0x14')]>0x0){const _0x2eb1d8=_0x2d847e['startRun'](_0x50bf7e,_0x1fe91d);for(const _0x35a082 of _0x1fe91d){_0x4ded22[a1_0x2258('0x4f')][_0x35a082]=_0x2eb1d8;}}});}function cloudEnabledTasksRunner(_0x531d76,_0x4b10cc,_0x362ded,_0xd652b4=![]){var _0x20f530;const _0x2640ee=process[a1_0x2258('0x23')][a1_0x2258('0x31')];const _0x42d132={'statuses':{},'scheduledTasks':[],'requests':{},'allTasks':_0x531d76};const _0x205690=_0x4b10cc[a1_0x2258('0x7')]===undefined;const _0x7894f6=[];const _0x8d3edd=new message_reporter_1['MessageReporter'](_0x4b10cc);const _0x4e1cef=createApi(_0x8d3edd,_0x4b10cc,_0x42d132);const _0x50a8d5=new end_of_run_message_1[(a1_0x2258('0x3b'))](_0x42d132,_0x7894f6,_0x2640ee);const _0x2ad964=new output_obfuscator_1[(a1_0x2258('0x3'))](_0x4b10cc[a1_0x2258('0x32')]);const _0x5ae865=new Date()[a1_0x2258('0x28')]();const _0x159878=createLifeCycle(_0x42d132,_0x4b10cc,_0x2ad964,_0x7894f6);const _0x5640b9=environment_1[a1_0x2258('0x4b')]||_0x4b10cc[a1_0x2258('0x4e')];const _0x1b5703=new e2e_encryption_1[(a1_0x2258('0x1c'))](_0x5640b9);const _0x477225=new error_reporter_api_1[(a1_0x2258('0x10'))](_0x4b10cc);const _0x3911ce=(0x0,environment_1[a1_0x2258('0xe')])(_0x2640ee)||!((_0x20f530=_0x362ded[a1_0x2258('0x48')])===null||_0x20f530===void 0x0?void 0x0:_0x20f530[a1_0x2258('0x4a')]());const _0xaf409e=new file_storage_1[(a1_0x2258('0x1e'))](_0x1b5703,_0x477225,_0x4b10cc,a1_0x2258('0x33'));const _0x5c7318=new cloud_remote_cache_1[(a1_0x2258('0x3a'))](_0x8d3edd,_0x4e1cef,_0x42d132,_0xaf409e,_0x2640ee,_0x3911ce);fetchUrlsForKnownHashesUpfront(_0x4e1cef,_0x42d132,_0x531d76,_0x4b10cc,_0x2640ee);delete process[a1_0x2258('0x23')][a1_0x2258('0x31')];const _0x780ce7=tasksRunner(_0x531d76,Object['assign'](Object[a1_0x2258('0x34')]({},_0x4b10cc),{'remoteCache':_0x5c7318,'lifeCycle':_0x159878}),_0x362ded);if(_0x780ce7['subscribe']){const {Subject}=require('rxjs/internal/Subject');const _0x5808b4=new Subject();_0x780ce7[a1_0x2258('0x39')]({'next':_0x31a650=>_0x5808b4[a1_0x2258('0x2f')](_0x31a650),'error':_0x28c681=>_0x5808b4[a1_0x2258('0x58')](_0x28c681),'complete':()=>__awaiter(this,void 0x0,void 0x0,function*(){const _0x5581ba=yield onComplete({'daemon':_0x362ded[a1_0x2258('0x48')],'options':_0x4b10cc,'fileStorage':_0xaf409e,'remoteCache':_0x5c7318,'api':_0x4e1cef,'outputObfuscator':_0x2ad964,'runStartTime':_0x5ae865,'messages':_0x8d3edd,'endOfRunMessage':_0x50a8d5,'taskExecutions':_0x7894f6,'versionOfNxBefore133':_0x205690,'inner':_0xd652b4,'encryptionKey':_0x5640b9,'storeInCurrentProcess':_0x3911ce,'runContext':_0x42d132,'distributedExecutionId':_0x2640ee});if(!_0x5581ba&&(0x0,environment_1['agentRunningInDistributedExecution'])(_0x2640ee)){process[a1_0x2258('0x1')](environment_1[a1_0x2258('0xc')]);}_0x5808b4[a1_0x2258('0xa')]();})});return _0x5808b4;}else{return _0x780ce7['then'](_0xc3ad18=>__awaiter(this,void 0x0,void 0x0,function*(){const _0x21d466=yield onComplete({'daemon':_0x362ded[a1_0x2258('0x48')],'options':_0x4b10cc,'fileStorage':_0xaf409e,'remoteCache':_0x5c7318,'api':_0x4e1cef,'outputObfuscator':_0x2ad964,'runStartTime':_0x5ae865,'messages':_0x8d3edd,'endOfRunMessage':_0x50a8d5,'taskExecutions':_0x7894f6,'versionOfNxBefore133':_0x205690,'inner':_0xd652b4,'encryptionKey':_0x5640b9,'storeInCurrentProcess':_0x3911ce,'runContext':_0x42d132,'distributedExecutionId':_0x2640ee});if(!_0x21d466&&(0x0,environment_1['agentRunningInDistributedExecution'])(_0x2640ee)){process[a1_0x2258('0x1')](environment_1[a1_0x2258('0xc')]);}return _0xc3ad18;}))[a1_0x2258('0x40')](_0x1e0fab=>__awaiter(this,void 0x0,void 0x0,function*(){const _0x595267=yield onComplete({'daemon':_0x362ded['daemon'],'options':_0x4b10cc,'fileStorage':_0xaf409e,'remoteCache':_0x5c7318,'api':_0x4e1cef,'outputObfuscator':_0x2ad964,'runStartTime':_0x5ae865,'messages':_0x8d3edd,'endOfRunMessage':_0x50a8d5,'taskExecutions':_0x7894f6,'versionOfNxBefore133':_0x205690,'inner':_0xd652b4,'encryptionKey':_0x5640b9,'storeInCurrentProcess':_0x3911ce,'runContext':_0x42d132,'distributedExecutionId':_0x2640ee});if(!_0x595267&&(0x0,environment_1[a1_0x2258('0xe')])(_0x2640ee)){process[a1_0x2258('0x1')](environment_1[a1_0x2258('0xc')]);}throw _0x1e0fab;}));}}exports['cloudEnabledTasksRunner']=cloudEnabledTasksRunner;